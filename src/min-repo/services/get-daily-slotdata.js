'use strict';var __importDefault=this&&this['__importDefault']||function(_0x3a0ee2){return _0x3a0ee2&&_0x3a0ee2['__esModule']?_0x3a0ee2:{'default':_0x3a0ee2};};Object['defineProperty'](exports,'__esModule',{'value':!![]});const puppeteer_1=__importDefault(require('../../services/puppeteer')),customError_1=require('../../@types/customError'),logger_1=require('../../utils/logger'),getDailySlotData={'getUrl':(_0x3d275c,_0x3074ac)=>{const _0x4793bf=new URLSearchParams({'kishu':_0x3074ac})['toString']();return _0x3d275c+'?'+_0x4793bf;},'getModelNames':async(_0x4238dc,_0x28d1f6)=>{try{const _0x197e9d=await puppeteer_1['default']['withCluster'](_0x4238dc,async({page:_0x473acf,data:_0x39902a})=>{try{await puppeteer_1['default']['navigation'](_0x473acf,_0x39902a['store_url']),await _0x473acf['waitForSelector']('.site-content\x20.tab_content',{'timeout':0x1e*0x3e8}),await _0x473acf['waitForSelector']('.site-content\x20ul.tab',{'timeout':0x1e*0x3e8}),await _0x473acf['evaluate'](()=>{const _0x393c7f=document['querySelector']('ul.tab');if(!_0x393c7f)return![];const _0x5605d2=_0x393c7f['querySelectorAll']('li');Array['from'](_0x5605d2)['some'](_0x455bbe=>{if(_0x455bbe['textContent']&&_0x455bbe['textContent']['trim']()==='機種別')return _0x455bbe['click'](),!![];return![];});}),await _0x473acf['waitForSelector']('.site-content\x20.tab_content',{'timeout':0x1e*0x3e8});const _0x18add3=await _0x473acf['evaluate']((_0x3ba148,_0x52134e,_0x2b05f3,_0x700996)=>{const _0x3f30dd=document['querySelector']('.site-content\x20.tab_content');if(!_0x3f30dd)return[];const _0x29b903=Array['from'](_0x3f30dd['querySelectorAll']('table.kishu\x20tbody\x20tr')),_0x5324c1=[];for(const _0x3a4d71 of _0x29b903){if(_0x3a4d71['querySelector']('th'))continue;const _0xc3fd48=_0x3a4d71['querySelector']('td\x20a');if(!_0xc3fd48)continue;const _0x59da04=(_0xc3fd48['textContent']||'')['trim']();if(!_0x59da04)continue;_0x5324c1['push']({'date':_0x3ba148,'machine_name':_0x59da04,'p_name':_0x52134e,'store_name':_0x2b05f3,'store_url':_0x700996});}return _0x5324c1;},_0x28d1f6,_0x39902a['p_name'],_0x39902a['store_name'],_0x39902a['store_url']);return logger_1['logger']['info']('Completed\x20extracting\x20model\x20names\x20for\x20store:\x20'+_0x39902a['store_name']+'\x20('+_0x39902a['p_name']+')\x20-\x20found\x20'+_0x18add3['length']+'\x20models'),_0x18add3;}catch(_0x248e4c){return logger_1['logger']['error']('Failed\x20to\x20get\x20model\x20names\x20for\x20store\x20'+(_0x39902a?.['store_name']||'')+':\x20'+_0x248e4c['message']),null;}}),_0x43f395=[];for(const _0x1a27d3 of _0x197e9d)if(_0x1a27d3&&_0x1a27d3['length'])_0x43f395['push'](..._0x1a27d3);return _0x43f395;}catch(_0x479293){return logger_1['logger']['error']('Failed\x20to\x20get\x20daily\x20slot\x20URLs:\x20'+_0x479293['message']),[];}},'getPageDatas':async(_0x4999ff,_0x1a7f7d)=>{try{const _0x1dfeb3=getDailySlotData['getUrl'](_0x1a7f7d['store_url'],_0x1a7f7d['machine_name']);await puppeteer_1['default']['navigation'](_0x4999ff,_0x1dfeb3),await _0x4999ff['waitForSelector']('.site-content',{'timeout':0x1e*0x3e8}),await _0x4999ff['evaluate'](()=>{const _0xb845a3=document['querySelector']('ul.tab');if(!_0xb845a3)return;const _0x3bf1bc=Array['from'](_0xb845a3['querySelectorAll']('li')),_0x15b48b=_0x3bf1bc['find'](_0x466767=>(_0x466767['textContent']||'')['trim']()==='データ一覧');if(_0x15b48b)_0x15b48b['click']();}),await _0x4999ff['waitForSelector']('.tab_content',{'timeout':0x1e*0x3e8});const _0x4a21b5=await _0x4999ff['evaluate']((_0x297772,_0x348aa5,_0x12e8db,_0x5db466)=>{const _0x13e1d9=[],_0x55eea5=Array['from'](document['querySelectorAll']('.tab_content')),_0x2b94d8=_0x55eea5['find'](_0x2c0296=>{const _0x48a458=(_0x2c0296['querySelector']('h2')?.['textContent']||'')['trim']();return _0x48a458['includes']('データ一覧');});if(!_0x2b94d8)return _0x13e1d9;const _0x1bb50b=_0x2b94d8['querySelector']('table');if(!_0x1bb50b)return _0x13e1d9;const _0x225261=Array['from']((_0x1bb50b['querySelector']('thead\x20tr')||_0x1bb50b['querySelector']('tbody\x20tr'))?.['querySelectorAll']('th')||[]),_0x3c7091=_0x225261['map'](_0x13e5b9=>(_0x13e5b9['textContent']||'')['trim']()),_0x425a65={};_0x3c7091['forEach']((_0x4358c8,_0x5db8ca)=>{_0x425a65[_0x4358c8]=_0x5db8ca;});const _0x1d9430=_0x425a65['台番']??0x0,_0x2823fc=_0x425a65['差枚'],_0x29e665=_0x425a65['G数']??0x1,_0x54da59=_0x425a65['出率'],_0x280eec=_0x425a65['BB']??0x2,_0x4c7369=_0x425a65['RB']??0x3,_0x2fa986=_0x425a65['合成']??0x4,_0x1e3663=_0x425a65['BB率'],_0x16f5c5=_0x425a65['RB率'],_0x166591=Array['from'](_0x1bb50b['querySelectorAll']('tbody\x20tr'));for(const _0xa09cb3 of _0x166591){if(_0xa09cb3['querySelector']('th'))continue;if(_0xa09cb3['classList']['contains']('avg_row'))continue;const _0x5685e1=Array['from'](_0xa09cb3['querySelectorAll']('td'));if(!_0x5685e1['length'])continue;const _0x34acbf=_0x5685e1[_0x1d9430]?.['querySelector']('a'),_0x599a50=(_0x34acbf?.['textContent']||'')['trim'](),_0x4ce244=_0x34acbf?.['href']||'',_0x37d17e=_0x2823fc!==undefined?(_0x5685e1[_0x2823fc]?.['textContent']||'')['trim']():'-',_0xf74d8c=(_0x5685e1[_0x29e665]?.['textContent']||'')['trim'](),_0x1fe01f=_0x54da59!==undefined?(_0x5685e1[_0x54da59]?.['textContent']||'')['trim']():'-',_0x13b57f=(_0x5685e1[_0x280eec]?.['textContent']||'')['trim'](),_0x573a53=(_0x5685e1[_0x4c7369]?.['textContent']||'')['trim'](),_0x2e9507=(_0x5685e1[_0x2fa986]?.['textContent']||'')['trim'](),_0x204649=_0x1e3663!==undefined?(_0x5685e1[_0x1e3663]?.['textContent']||'')['trim']():'-',_0x39f618=_0x16f5c5!==undefined?(_0x5685e1[_0x16f5c5]?.['textContent']||'')['trim']():'-';if(!_0x599a50)continue;_0x13e1d9['push']({'date':_0x297772,'machine_name':_0x348aa5,'p_name':_0x12e8db,'store_name':_0x5db466,'machine_number':_0x599a50,'credit_difference':_0x37d17e,'game_count':_0xf74d8c,'payout_rate':_0x1fe01f,'bb':_0x13b57f,'rb':_0x573a53,'synthesis':_0x2e9507,'bb_rate':_0x204649,'rb_rate':_0x39f618,'data_url':_0x4ce244});}return _0x13e1d9;},_0x1a7f7d['date'],_0x1a7f7d['machine_name'],_0x1a7f7d['p_name'],_0x1a7f7d['store_name']);return _0x4a21b5;}catch(_0x12a8ab){return logger_1['logger']['error']('Failed\x20to\x20get\x20page\x20data\x20for\x20model\x20'+_0x1a7f7d['machine_name']+':\x20'+_0x12a8ab['message']),[];}},'getslotData':async _0xcdadf3=>{try{const _0x5f0519=await puppeteer_1['default']['withCluster'](_0xcdadf3,async({page:_0x38d9e9,data:_0x5bdde5})=>{try{const _0x5ae7a1=getDailySlotData['getUrl'](_0x5bdde5['store_url'],_0x5bdde5['machine_name']);await puppeteer_1['default']['navigation'](_0x38d9e9,_0x5ae7a1),await _0x38d9e9['waitForSelector']('.site-content',{'timeout':0xa*0x3e8}),await _0x38d9e9['evaluate'](()=>{const _0x550485=document['querySelector']('ul.tab');if(!_0x550485)return;const _0x41a98a=Array['from'](_0x550485['querySelectorAll']('li')),_0x582c99=_0x41a98a['find'](_0x23fc55=>(_0x23fc55['textContent']||'')['trim']()==='データ一覧');if(_0x582c99)_0x582c99['click']();}),await _0x38d9e9['waitForSelector']('.tab_content',{'timeout':0xa*0x3e8});const _0x18fcc6=await _0x38d9e9['evaluate']((_0x124b5f,_0xeecdbe,_0x11df46,_0x19c36d)=>{const _0x58cd4b=[],_0x57877a=Array['from'](document['querySelectorAll']('.tab_content')),_0x1eebf7=_0x57877a['find'](_0x3852fd=>{const _0x22cd02=(_0x3852fd['querySelector']('h2')?.['textContent']||'')['trim']();return _0x22cd02['includes']('データ一覧');});if(!_0x1eebf7)return _0x58cd4b;const _0x37d8bd=_0x1eebf7['querySelector']('table');if(!_0x37d8bd)return _0x58cd4b;const _0x3d99f7=Array['from']((_0x37d8bd['querySelector']('thead\x20tr')||_0x37d8bd['querySelector']('tbody\x20tr'))?.['querySelectorAll']('th')||[]),_0x47a6dc=_0x3d99f7['map'](_0x314ec4=>(_0x314ec4['textContent']||'')['trim']()),_0x45fcd6={};_0x47a6dc['forEach']((_0x39484e,_0x567072)=>{_0x45fcd6[_0x39484e]=_0x567072;});const _0x56daeb=_0x45fcd6['台番']??0x0,_0x2c6364=_0x45fcd6['差枚'],_0x2b0f95=_0x45fcd6['G数']??0x1,_0x438fd4=_0x45fcd6['出率'],_0x225813=_0x45fcd6['BB']??0x2,_0x5639af=_0x45fcd6['RB']??0x3,_0x3ce8a8=_0x45fcd6['合成']??0x4,_0x335e70=_0x45fcd6['BB率'],_0x1141a4=_0x45fcd6['RB率'],_0x8360b5=Array['from'](_0x37d8bd['querySelectorAll']('tbody\x20tr'));for(const _0x968a66 of _0x8360b5){if(_0x968a66['querySelector']('th'))continue;if(_0x968a66['classList']['contains']('avg_row'))continue;const _0x257dcd=Array['from'](_0x968a66['querySelectorAll']('td'));if(!_0x257dcd['length'])continue;const _0x4c59d5=_0x257dcd[_0x56daeb]?.['querySelector']('a'),_0x46e627=(_0x4c59d5?.['textContent']||'')['trim'](),_0x4929fb=_0x4c59d5?.['href']||'',_0x216d14=_0x2c6364!==undefined?(_0x257dcd[_0x2c6364]?.['textContent']||'')['trim']():'-',_0x2c4314=(_0x257dcd[_0x2b0f95]?.['textContent']||'')['trim'](),_0x42322e=_0x438fd4!==undefined?(_0x257dcd[_0x438fd4]?.['textContent']||'')['trim']():'-',_0x390066=(_0x257dcd[_0x225813]?.['textContent']||'')['trim'](),_0x3bd8cb=(_0x257dcd[_0x5639af]?.['textContent']||'')['trim'](),_0xe6964f=(_0x257dcd[_0x3ce8a8]?.['textContent']||'')['trim'](),_0x5d7a9a=_0x335e70!==undefined?(_0x257dcd[_0x335e70]?.['textContent']||'')['trim']():'-',_0x388a21=_0x1141a4!==undefined?(_0x257dcd[_0x1141a4]?.['textContent']||'')['trim']():'-';if(!_0x46e627)continue;_0x58cd4b['push']({'date':_0x124b5f,'machine_name':_0xeecdbe,'p_name':_0x11df46,'store_name':_0x19c36d,'machine_number':_0x46e627,'credit_difference':_0x216d14,'game_count':_0x2c4314,'payout_rate':_0x42322e,'bb':_0x390066,'rb':_0x3bd8cb,'synthesis':_0xe6964f,'bb_rate':_0x5d7a9a,'rb_rate':_0x388a21,'data_url':_0x4929fb});}return _0x58cd4b;},_0x5bdde5['date'],_0x5bdde5['machine_name'],_0x5bdde5['p_name'],_0x5bdde5['store_name']);return logger_1['logger']['info']('Extracted\x20'+(_0x18fcc6?.['length']||0x0)+'\x20slot\x20data\x20rows\x20for\x20model:\x20'+_0x5bdde5['machine_name']+',\x20store:\x20'+_0x5bdde5['store_name']),_0x18fcc6||[];}catch(_0x5d1ced){return logger_1['logger']['error']('getslotData\x20error\x20for\x20model\x20'+_0x5bdde5?.['machine_name']+':\x20'+_0x5d1ced['message']),null;}}),_0x202c29=[];for(const _0x34ed84 of _0x5f0519)if(_0x34ed84&&_0x34ed84['length'])_0x202c29['push'](..._0x34ed84);return logger_1['logger']['info']('getslotData\x20completed:\x20Total\x20slot\x20rows\x20collected:\x20'+_0x202c29['length']),_0x202c29;}catch(_0x326388){return logger_1['logger']['error']('getslotData\x20failed:\x20'+_0x326388['message']),[];}},'extraDatas':async(_0x1e847e,_0x180164)=>{try{logger_1['logger']['info']('Starting\x20extraction\x20of\x20machine\x20models\x20for\x20'+_0x1e847e['length']+'\x20stores\x20on\x20'+_0x180164+'...');const _0x5b9f02=await getDailySlotData['getModelNames'](_0x1e847e,_0x180164);logger_1['logger']['info']('Successfully\x20extracted\x20'+_0x5b9f02['length']+'\x20machine\x20models.\x20Now\x20extracting\x20slot\x20data...');const _0x593116=await getDailySlotData['getslotData'](_0x5b9f02);return logger_1['logger']['info']('Extraction\x20complete!\x20Collected\x20'+_0x593116['length']+'\x20slot\x20data\x20rows\x20for\x20'+_0x5b9f02['length']+'\x20models.'),[_0x5b9f02,_0x593116];}catch(_0x267f51){logger_1['logger']['error']('Failed\x20to\x20extract\x20daily\x20slot\x20data:\x20'+_0x267f51['message']);throw new customError_1['SystemError']('Failed\x20to\x20extract\x20daily\x20slot\x20data:\x20'+_0x267f51['message']);}}};exports['default']=getDailySlotData;
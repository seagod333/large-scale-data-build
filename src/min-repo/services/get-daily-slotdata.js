'use strict';var __importDefault=this&&this['__importDefault']||function(_0x2d85eb){return _0x2d85eb&&_0x2d85eb['__esModule']?_0x2d85eb:{'default':_0x2d85eb};};Object['defineProperty'](exports,'__esModule',{'value':!![]});const puppeteer_1=__importDefault(require('../../services/puppeteer')),customError_1=require('../../@types/customError'),logger_1=require('../../utils/logger'),getDailySlotData={'getUrl':(_0x2869e2,_0x294ddf)=>{const _0x38f807=new URLSearchParams({'kishu':_0x294ddf})['toString']();return _0x2869e2+'?'+_0x38f807;},'getModelNames':async(_0xcc5dab,_0x3e5014)=>{try{const _0x5660bf=await puppeteer_1['default']['withCluster'](_0xcc5dab,async({page:_0x52fcaa,data:_0x56c40c})=>{try{await puppeteer_1['default']['navigation'](_0x52fcaa,_0x56c40c['store_url']),await _0x52fcaa['waitForSelector']('.site-content\x20.tab_content',{'timeout':0x1e*0x3e8}),await _0x52fcaa['waitForSelector']('.site-content\x20ul.tab',{'timeout':0x1e*0x3e8}),await _0x52fcaa['evaluate'](()=>{const _0x2a129d=document['querySelector']('ul.tab');if(!_0x2a129d)return![];const _0x2cc6d2=_0x2a129d['querySelectorAll']('li');Array['from'](_0x2cc6d2)['some'](_0x44745f=>{if(_0x44745f['textContent']&&_0x44745f['textContent']['trim']()==='機種別')return _0x44745f['click'](),!![];return![];});}),await _0x52fcaa['waitForSelector']('.site-content\x20.tab_content',{'timeout':0x1e*0x3e8});const _0x5959cd=await _0x52fcaa['evaluate']((_0x1d2a54,_0x1b55ae,_0x4d2239,_0xbb9db5)=>{const _0x58eb8a=document['querySelector']('.site-content\x20.tab_content');if(!_0x58eb8a)return[];const _0x193629=Array['from'](_0x58eb8a['querySelectorAll']('table.kishu\x20tbody\x20tr')),_0x24eae5=[];for(const _0x78560a of _0x193629){if(_0x78560a['querySelector']('th'))continue;const _0x3a2861=_0x78560a['querySelector']('td\x20a');if(!_0x3a2861)continue;const _0xdaf14e=(_0x3a2861['textContent']||'')['trim']();if(!_0xdaf14e)continue;_0x24eae5['push']({'date':_0x1d2a54,'machine_name':_0xdaf14e,'p_name':_0x1b55ae,'store_name':_0x4d2239,'store_url':_0xbb9db5});}return _0x24eae5;},_0x3e5014,_0x56c40c['p_name'],_0x56c40c['store_name'],_0x56c40c['store_url']);return logger_1['logger']['info']('Completed\x20extracting\x20model\x20names\x20for\x20store:\x20'+_0x56c40c['store_name']+'\x20('+_0x56c40c['p_name']+')\x20-\x20found\x20'+_0x5959cd['length']+'\x20models'),_0x5959cd;}catch(_0x347836){return logger_1['logger']['error']('Failed\x20to\x20get\x20model\x20names\x20for\x20store\x20'+(_0x56c40c?.['store_name']||'')+':\x20'+_0x347836['message']),null;}}),_0x59edc1=[];for(const _0x12cd3a of _0x5660bf)if(_0x12cd3a&&_0x12cd3a['length'])_0x59edc1['push'](..._0x12cd3a);return _0x59edc1;}catch(_0x4fb553){return logger_1['logger']['error']('Failed\x20to\x20get\x20daily\x20slot\x20URLs:\x20'+_0x4fb553['message']),[];}},'getPageDatas':async(_0x5b91c1,_0x59c0ae)=>{try{const _0x718cb1=getDailySlotData['getUrl'](_0x59c0ae['store_url'],_0x59c0ae['machine_name']);await puppeteer_1['default']['navigation'](_0x5b91c1,_0x718cb1),await _0x5b91c1['waitForSelector']('.site-content',{'timeout':0x1e*0x3e8}),await _0x5b91c1['evaluate'](()=>{const _0x557974=document['querySelector']('ul.tab');if(!_0x557974)return;const _0x4e36e6=Array['from'](_0x557974['querySelectorAll']('li')),_0xa10b8a=_0x4e36e6['find'](_0x4082ae=>(_0x4082ae['textContent']||'')['trim']()==='データ一覧');if(_0xa10b8a)_0xa10b8a['click']();}),await _0x5b91c1['waitForSelector']('.tab_content',{'timeout':0x1e*0x3e8});const _0x38bb77=await _0x5b91c1['evaluate']((_0x126136,_0x1aca50,_0xf38609,_0x1339c0)=>{const _0x7f00d8=[],_0x51170a=Array['from'](document['querySelectorAll']('.tab_content')),_0x383a5c=_0x51170a['find'](_0x360c5c=>{const _0x5e75e1=(_0x360c5c['querySelector']('h2')?.['textContent']||'')['trim']();return _0x5e75e1['includes']('データ一覧');});if(!_0x383a5c)return _0x7f00d8;const _0x2ef16a=_0x383a5c['querySelector']('table');if(!_0x2ef16a)return _0x7f00d8;const _0x212513=Array['from']((_0x2ef16a['querySelector']('thead\x20tr')||_0x2ef16a['querySelector']('tbody\x20tr'))?.['querySelectorAll']('th')||[]),_0x199aa9=_0x212513['map'](_0x2bb99e=>(_0x2bb99e['textContent']||'')['trim']()),_0xe2f013={};_0x199aa9['forEach']((_0x51db27,_0x583da0)=>{_0xe2f013[_0x51db27]=_0x583da0;});const _0x817e47=_0xe2f013['台番']??0x0,_0x2dd604=_0xe2f013['差枚'],_0x49fbb1=_0xe2f013['G数']??0x1,_0x9e7028=_0xe2f013['出率'],_0xf1131d=_0xe2f013['BB']??0x2,_0x17cfcd=_0xe2f013['RB']??0x3,_0x236dbb=_0xe2f013['合成']??0x4,_0x3db845=_0xe2f013['BB率'],_0x2cc9f1=_0xe2f013['RB率'],_0x5dac57=Array['from'](_0x2ef16a['querySelectorAll']('tbody\x20tr'));for(const _0x122230 of _0x5dac57){if(_0x122230['querySelector']('th'))continue;if(_0x122230['classList']['contains']('avg_row'))continue;const _0xadd640=Array['from'](_0x122230['querySelectorAll']('td'));if(!_0xadd640['length'])continue;const _0x4daff3=_0xadd640[_0x817e47]?.['querySelector']('a'),_0xaf5cca=(_0x4daff3?.['textContent']||'')['trim'](),_0x50f9ba=_0x4daff3?.['href']||'',_0x1e30b1=_0x2dd604!==undefined?(_0xadd640[_0x2dd604]?.['textContent']||'')['trim']():'-',_0x5616b3=(_0xadd640[_0x49fbb1]?.['textContent']||'')['trim'](),_0x534c05=_0x9e7028!==undefined?(_0xadd640[_0x9e7028]?.['textContent']||'')['trim']():'-',_0x72cba9=(_0xadd640[_0xf1131d]?.['textContent']||'')['trim'](),_0x37ffb4=(_0xadd640[_0x17cfcd]?.['textContent']||'')['trim'](),_0x2386f3=(_0xadd640[_0x236dbb]?.['textContent']||'')['trim'](),_0x1c7a09=_0x3db845!==undefined?(_0xadd640[_0x3db845]?.['textContent']||'')['trim']():'-',_0x960704=_0x2cc9f1!==undefined?(_0xadd640[_0x2cc9f1]?.['textContent']||'')['trim']():'-';if(!_0xaf5cca)continue;_0x7f00d8['push']({'date':_0x126136,'machine_name':_0x1aca50,'p_name':_0xf38609,'store_name':_0x1339c0,'machine_number':_0xaf5cca,'credit_difference':_0x1e30b1,'game_count':_0x5616b3,'payout_rate':_0x534c05,'bb':_0x72cba9,'rb':_0x37ffb4,'synthesis':_0x2386f3,'bb_rate':_0x1c7a09,'rb_rate':_0x960704,'data_url':_0x50f9ba});}return _0x7f00d8;},_0x59c0ae['date'],_0x59c0ae['machine_name'],_0x59c0ae['p_name'],_0x59c0ae['store_name']);return _0x38bb77;}catch(_0x42cf92){return logger_1['logger']['error']('Failed\x20to\x20get\x20page\x20data\x20for\x20model\x20'+_0x59c0ae['machine_name']+':\x20'+_0x42cf92['message']),[];}},'getslotData':async _0x2374f9=>{try{const _0x56972a=await puppeteer_1['default']['withCluster'](_0x2374f9,async({page:_0x275518,data:_0x64d3d})=>{try{const _0x578fce=getDailySlotData['getUrl'](_0x64d3d['store_url'],_0x64d3d['machine_name']);await puppeteer_1['default']['navigation'](_0x275518,_0x578fce),await _0x275518['waitForSelector']('.site-content',{'timeout':0xa*0x3e8}),await _0x275518['evaluate'](()=>{const _0x4607f6=document['querySelector']('ul.tab');if(!_0x4607f6)return;const _0x4da1d0=Array['from'](_0x4607f6['querySelectorAll']('li')),_0xd6341=_0x4da1d0['find'](_0x5f0f23=>(_0x5f0f23['textContent']||'')['trim']()==='データ一覧');if(_0xd6341)_0xd6341['click']();}),await _0x275518['waitForSelector']('.tab_content',{'timeout':0xa*0x3e8});const _0x34116a=await _0x275518['evaluate']((_0x2dbe28,_0x445cb9,_0x202b4e,_0x546b54)=>{const _0x522ca2=[],_0x3a1c9a=Array['from'](document['querySelectorAll']('.tab_content')),_0xa97202=_0x3a1c9a['find'](_0x3a68b1=>{const _0x259134=(_0x3a68b1['querySelector']('h2')?.['textContent']||'')['trim']();return _0x259134['includes']('データ一覧');});if(!_0xa97202)return _0x522ca2;const _0x2c575f=_0xa97202['querySelector']('table');if(!_0x2c575f)return _0x522ca2;const _0x5c0631=Array['from']((_0x2c575f['querySelector']('thead\x20tr')||_0x2c575f['querySelector']('tbody\x20tr'))?.['querySelectorAll']('th')||[]),_0x4b9d84=_0x5c0631['map'](_0x272c5b=>(_0x272c5b['textContent']||'')['trim']()),_0x4a87da={};_0x4b9d84['forEach']((_0x418f6d,_0x152afc)=>{_0x4a87da[_0x418f6d]=_0x152afc;});const _0x3171a9=_0x4a87da['台番']??0x0,_0x4ea7cb=_0x4a87da['差枚'],_0x39f9c0=_0x4a87da['G数']??0x1,_0x546d9e=_0x4a87da['出率'],_0x561045=_0x4a87da['BB']??0x2,_0x2ac0e3=_0x4a87da['RB']??0x3,_0x5370e9=_0x4a87da['合成']??0x4,_0x45371d=_0x4a87da['BB率'],_0x2b279a=_0x4a87da['RB率'],_0x464d08=Array['from'](_0x2c575f['querySelectorAll']('tbody\x20tr'));for(const _0x294f13 of _0x464d08){if(_0x294f13['querySelector']('th'))continue;if(_0x294f13['classList']['contains']('avg_row'))continue;const _0x514c26=Array['from'](_0x294f13['querySelectorAll']('td'));if(!_0x514c26['length'])continue;const _0x5bb13b=_0x514c26[_0x3171a9]?.['querySelector']('a'),_0x1e980f=(_0x5bb13b?.['textContent']||'')['trim'](),_0x3f067a=_0x5bb13b?.['href']||'',_0x45dbc7=_0x4ea7cb!==undefined?(_0x514c26[_0x4ea7cb]?.['textContent']||'')['trim']():'-',_0x10215=(_0x514c26[_0x39f9c0]?.['textContent']||'')['trim'](),_0x97f432=_0x546d9e!==undefined?(_0x514c26[_0x546d9e]?.['textContent']||'')['trim']():'-',_0x2954f7=(_0x514c26[_0x561045]?.['textContent']||'')['trim'](),_0x3b56ab=(_0x514c26[_0x2ac0e3]?.['textContent']||'')['trim'](),_0x38ea97=(_0x514c26[_0x5370e9]?.['textContent']||'')['trim'](),_0x769e25=_0x45371d!==undefined?(_0x514c26[_0x45371d]?.['textContent']||'')['trim']():'-',_0x16f7b9=_0x2b279a!==undefined?(_0x514c26[_0x2b279a]?.['textContent']||'')['trim']():'-';if(!_0x1e980f)continue;_0x522ca2['push']({'date':_0x2dbe28,'machine_name':_0x445cb9,'p_name':_0x202b4e,'store_name':_0x546b54,'machine_number':_0x1e980f,'credit_difference':_0x45dbc7,'game_count':_0x10215,'payout_rate':_0x97f432,'bb':_0x2954f7,'rb':_0x3b56ab,'synthesis':_0x38ea97,'bb_rate':_0x769e25,'rb_rate':_0x16f7b9,'data_url':_0x3f067a});}return _0x522ca2;},_0x64d3d['date'],_0x64d3d['machine_name'],_0x64d3d['p_name'],_0x64d3d['store_name']);return logger_1['logger']['info']('Extracted\x20'+(_0x34116a?.['length']||0x0)+'\x20slot\x20data\x20rows\x20for\x20model:\x20'+_0x64d3d['machine_name']+',\x20store:\x20'+_0x64d3d['store_name']),_0x34116a||[];}catch(_0x59257d){return logger_1['logger']['error']('getslotData\x20error\x20for\x20model\x20'+_0x64d3d?.['machine_name']+':\x20'+_0x59257d['message']),null;}}),_0x3ef8fd=[];for(const _0x2e726e of _0x56972a)if(_0x2e726e&&_0x2e726e['length'])_0x3ef8fd['push'](..._0x2e726e);return logger_1['logger']['info']('getslotData\x20completed:\x20Total\x20slot\x20rows\x20collected:\x20'+_0x3ef8fd['length']),_0x3ef8fd;}catch(_0x3179bb){return logger_1['logger']['error']('getslotData\x20failed:\x20'+_0x3179bb['message']),[];}},'extraDatas':async(_0xc02d5f,_0x3e51e1)=>{try{logger_1['logger']['info']('Starting\x20extraction\x20of\x20machine\x20models\x20for\x20'+_0xc02d5f['length']+'\x20stores\x20on\x20'+_0x3e51e1+'...');const _0x30ba3b=await getDailySlotData['getModelNames'](_0xc02d5f,_0x3e51e1);logger_1['logger']['info']('Successfully\x20extracted\x20'+_0x30ba3b['length']+'\x20machine\x20models.\x20Now\x20extracting\x20slot\x20data...');const _0x56589f=await getDailySlotData['getslotData'](_0x30ba3b);return logger_1['logger']['info']('Extraction\x20complete!\x20Collected\x20'+_0x56589f['length']+'\x20slot\x20data\x20rows\x20for\x20'+_0x30ba3b['length']+'\x20models.'),[_0x30ba3b,_0x56589f];}catch(_0x597a2f){logger_1['logger']['error']('Failed\x20to\x20extract\x20daily\x20slot\x20data:\x20'+_0x597a2f['message']);throw new customError_1['SystemError']('Failed\x20to\x20extract\x20daily\x20slot\x20data:\x20'+_0x597a2f['message']);}}};exports['default']=getDailySlotData;
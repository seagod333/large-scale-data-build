'use strict';var __importDefault=this&&this['__importDefault']||function(_0x36ec07){return _0x36ec07&&_0x36ec07['__esModule']?_0x36ec07:{'default':_0x36ec07};};Object['defineProperty'](exports,'__esModule',{'value':!![]});const models_1=__importDefault(require('../models')),customError_1=require('../../@types/customError'),logger_1=require('../../utils/logger'),database_1=require('../../services/database'),dailySlotDataDB={'create':async _0x36ce93=>{const _0x50c699=new models_1['default']['dailySlotData'](_0x36ce93),_0x59cdc5=await _0x50c699['save']();if(!_0x59cdc5)throw new customError_1['DatabaseError']('dailySlotDataDB\x20Database\x20Error');return _0x59cdc5;},'findOne':async({filter:_0x9fefea})=>{return models_1['default']['dailySlotData']['findOne'](_0x9fefea);},'find':async({filter:_0x220352})=>{return models_1['default']['dailySlotData']['find'](_0x220352);},'update':async({filter:_0x660b03,update:_0x177031})=>{return models_1['default']['dailySlotData']['findOneAndUpdate'](_0x660b03,_0x177031);},'remove':async({filter:_0x1aceed})=>{const _0x30e9c4=await models_1['default']['dailySlotData']['deleteOne'](_0x1aceed);return{'found':_0x30e9c4['n'],'deleted':_0x30e9c4['deletedCount']};},'saveDatas':async _0x386e8f=>{try{if(!_0x386e8f||_0x386e8f['length']===0x0)throw new customError_1['DatabaseError']('No\x20data\x20provided');logger_1['logger']['info']('Processing\x20'+_0x386e8f['length']+'\x20daily\x20slot\x20records...');const _0x40bee8=new Set();for(const _0x1ab560 of _0x386e8f){if(_0x1ab560?.['date'])_0x40bee8['add'](_0x1ab560['date']);}const _0x8264d1=Array['from'](_0x40bee8),[_0x12295e,_0x583d83,_0x5c49fe]=await Promise['all']([models_1['default']['prefectureModel']['find']({},{'_id':0x1,'p_name':0x1}),models_1['default']['storeMaster']['find']({},{'_id':0x1,'pref_id':0x1,'store_name':0x1}),models_1['default']['machineModel']['find']({},{'_id':0x1,'machine_name':0x1})]),_0x2331d4=new Map();_0x12295e['forEach'](_0x247142=>{if(_0x247142?.['p_name'])_0x2331d4['set'](_0x247142['p_name'],_0x247142['_id']);});const _0xf5379b=new Map();_0x583d83['forEach'](_0x48c3ba=>{_0x48c3ba?.['store_name']&&typeof _0x48c3ba?.['pref_id']==='number'&&_0xf5379b['set'](_0x48c3ba['store_name']+'_'+_0x48c3ba['pref_id'],_0x48c3ba['_id']);});const _0x47ca29=new Map();_0x5c49fe['forEach'](_0x5028ef=>{if(_0x5028ef?.['machine_name'])_0x47ca29['set'](_0x5028ef['machine_name'],_0x5028ef['_id']);});const _0x379662=await models_1['default']['dailySlotData']['find']({'date':{'$in':_0x8264d1}},{'_id':0x0,'date':0x1,'store_id':0x1,'machine_id':0x1,'machine_number':0x1}),_0x324d51=new Set();_0x379662['forEach'](_0x722820=>{const _0x9da473=_0x722820['date']+'_'+_0x722820['store_id']+'_'+_0x722820['machine_id']+'_'+_0x722820['machine_number'];_0x324d51['add'](_0x9da473);});let _0x55f1df=await(0x0,database_1['getLastIndex'])(models_1['default']['dailySlotData']);const _0x186936=[],_0x53d6d7=[];let _0x6010d3=0x0;const _0x3f4991=new Set();for(const _0x362b46 of _0x386e8f){const _0x4458dd=(_0x362b46?.['date']||'')['trim'](),_0x9b6ada=(_0x362b46?.['p_name']||'')['trim'](),_0x4f6d90=(_0x362b46?.['store_name']||'')['trim'](),_0xdf23c4=(_0x362b46?.['machine_name']||'')['trim'](),_0x2485a0=(_0x362b46?.['machine_number']||'')['trim']();if(!_0x4458dd||!_0x9b6ada||!_0x4f6d90||!_0xdf23c4||!_0x2485a0){_0x53d6d7['push']({'reason':'Missing\x20required\x20fields','item':_0x362b46});continue;}const _0x24946a=_0x2331d4['get'](_0x9b6ada);if(!_0x24946a){_0x53d6d7['push']({'reason':'Prefecture\x20\x27'+_0x9b6ada+'\x27\x20not\x20found','item':_0x362b46});continue;}const _0x4c8163=_0xf5379b['get'](_0x4f6d90+'_'+_0x24946a);if(!_0x4c8163){_0x53d6d7['push']({'reason':'Store\x20\x27'+_0x4f6d90+'\x27\x20not\x20found\x20for\x20prefecture\x20'+_0x9b6ada,'item':_0x362b46});continue;}const _0x2b7536=_0x47ca29['get'](_0xdf23c4);if(!_0x2b7536){_0x53d6d7['push']({'reason':'Machine\x20\x27'+_0xdf23c4+'\x27\x20not\x20found','item':_0x362b46});continue;}const _0x546b13=_0x4458dd+'_'+_0x4c8163+'_'+_0x2b7536+'_'+_0x2485a0;if(_0x324d51['has'](_0x546b13)){_0x53d6d7['push']({'reason':'Record\x20already\x20exists','item':_0x362b46});continue;}if(_0x3f4991['has'](_0x546b13)){_0x53d6d7['push']({'reason':'Duplicate\x20in\x20input','item':_0x362b46});continue;}_0x186936['push']({'_id':_0x55f1df++,'date':_0x4458dd,'pref_id':_0x24946a,'store_id':_0x4c8163,'machine_id':_0x2b7536,'machine_number':_0x2485a0,'credit_difference':(_0x362b46['credit_difference']||'')['trim'](),'game_count':(_0x362b46['game_count']||'')['trim'](),'payout_rate':(_0x362b46['payout_rate']||'')['trim'](),'bb':(_0x362b46['bb']||'')['trim'](),'rb':(_0x362b46['rb']||'')['trim'](),'synthesis':(_0x362b46['synthesis']||'')['trim'](),'bb_rate':(_0x362b46['bb_rate']||'')['trim'](),'rb_rate':(_0x362b46['rb_rate']||'')['trim'](),'data_url':(_0x362b46['data_url']||'')['trim']()}),_0x3f4991['add'](_0x546b13),_0x6010d3++;}const _0x26373b=0x3e8,_0x4b0d3e=[];for(let _0x3fa339=0x0;_0x3fa339<_0x186936['length'];_0x3fa339+=_0x26373b){_0x4b0d3e['push'](_0x186936['slice'](_0x3fa339,_0x3fa339+_0x26373b));}let _0x115c2a=0x0,_0x3672d7=0x0;const _0x415ce2=[];for(let _0x1799d3=0x0;_0x1799d3<_0x4b0d3e['length'];_0x1799d3++){const _0xe0081d=_0x4b0d3e[_0x1799d3];try{const _0x40b1e1=await models_1['default']['dailySlotData']['insertMany'](_0xe0081d,{'ordered':![],'rawResult':![]});_0x115c2a+=_0x40b1e1['length'];}catch(_0x557b3d){_0x557b3d?.['writeErrors']?(_0x3672d7+=_0x557b3d['writeErrors']['length'],_0x557b3d['writeErrors']['forEach'](_0x489a6c=>{_0x415ce2['push']({'batch':_0x1799d3+0x1,'error':_0x489a6c?.['errmsg'],'document':_0x489a6c?.['op']});})):(_0x3672d7+=_0xe0081d['length'],_0x415ce2['push']({'batch':_0x1799d3+0x1,'error':_0x557b3d?.['message'],'document':'entire\x20batch'}));}}return logger_1['logger']['info']('Bulk\x20operation\x20completed:\x20'+_0x115c2a+'\x20inserted,\x20'+_0x3672d7+'\x20errors'),{'success':!![],'totalProcessed':_0x386e8f['length'],'validRecords':_0x6010d3,'savedRows':_0x115c2a,'skippedRows':_0x53d6d7['length'],'errors':_0x3672d7,'errorDetails':_0x415ce2['slice'](0x0,0xa),'skipped':_0x53d6d7['slice'](0x0,0x64)};}catch(_0x1f0691){throw new customError_1['DatabaseError']('saveDatas\x20Error:\x20'+_0x1f0691?.['message']);}}};exports['default']=dailySlotDataDB;
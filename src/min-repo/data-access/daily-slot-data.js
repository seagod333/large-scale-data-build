'use strict';var __importDefault=this&&this['__importDefault']||function(_0x480db3){return _0x480db3&&_0x480db3['__esModule']?_0x480db3:{'default':_0x480db3};};Object['defineProperty'](exports,'__esModule',{'value':!![]});const models_1=__importDefault(require('../models')),customError_1=require('../../@types/customError'),logger_1=require('../../utils/logger'),database_1=require('../../services/database'),dailySlotDataDB={'create':async _0x2a302d=>{const _0x4f5fea=new models_1['default']['dailySlotData'](_0x2a302d),_0x24d1b8=await _0x4f5fea['save']();if(!_0x24d1b8)throw new customError_1['DatabaseError']('dailySlotDataDB\x20Database\x20Error');return _0x24d1b8;},'findOne':async({filter:_0x542c64})=>{return models_1['default']['dailySlotData']['findOne'](_0x542c64);},'find':async({filter:_0x5ab304})=>{return models_1['default']['dailySlotData']['find'](_0x5ab304);},'update':async({filter:_0x57492b,update:_0xa915e9})=>{return models_1['default']['dailySlotData']['findOneAndUpdate'](_0x57492b,_0xa915e9);},'remove':async({filter:_0x42ba38})=>{const _0x22afdc=await models_1['default']['dailySlotData']['deleteOne'](_0x42ba38);return{'found':_0x22afdc['n'],'deleted':_0x22afdc['deletedCount']};},'saveDatas':async _0x563d1c=>{try{if(!_0x563d1c||_0x563d1c['length']===0x0)throw new customError_1['DatabaseError']('No\x20data\x20provided');logger_1['logger']['info']('Processing\x20'+_0x563d1c['length']+'\x20daily\x20slot\x20records...');const _0x83f12=new Set();for(const _0x3be1c7 of _0x563d1c){if(_0x3be1c7?.['date'])_0x83f12['add'](_0x3be1c7['date']);}const _0x204be6=Array['from'](_0x83f12),[_0x2e1c10,_0x39159c,_0x4489da]=await Promise['all']([models_1['default']['prefectureModel']['find']({},{'_id':0x1,'p_name':0x1}),models_1['default']['storeMaster']['find']({},{'_id':0x1,'pref_id':0x1,'store_name':0x1}),models_1['default']['machineModel']['find']({},{'_id':0x1,'machine_name':0x1})]),_0x2a3a38=new Map();_0x2e1c10['forEach'](_0xcdfb29=>{if(_0xcdfb29?.['p_name'])_0x2a3a38['set'](_0xcdfb29['p_name'],_0xcdfb29['_id']);});const _0xe3ab6f=new Map();_0x39159c['forEach'](_0xe6cd=>{_0xe6cd?.['store_name']&&typeof _0xe6cd?.['pref_id']==='number'&&_0xe3ab6f['set'](_0xe6cd['store_name']+'_'+_0xe6cd['pref_id'],_0xe6cd['_id']);});const _0x4b2273=new Map();_0x4489da['forEach'](_0x5863c3=>{if(_0x5863c3?.['machine_name'])_0x4b2273['set'](_0x5863c3['machine_name'],_0x5863c3['_id']);});const _0x34c535=await models_1['default']['dailySlotData']['find']({'date':{'$in':_0x204be6}},{'_id':0x0,'date':0x1,'store_id':0x1,'machine_id':0x1,'machine_number':0x1}),_0x333e80=new Set();_0x34c535['forEach'](_0x16dcf5=>{const _0x312025=_0x16dcf5['date']+'_'+_0x16dcf5['store_id']+'_'+_0x16dcf5['machine_id']+'_'+_0x16dcf5['machine_number'];_0x333e80['add'](_0x312025);});let _0x44f082=await(0x0,database_1['getLastIndex'])(models_1['default']['dailySlotData']);const _0x17769e=[],_0x5e3b0a=[];let _0x2c53ce=0x0;const _0x2042fd=new Set();for(const _0x5b15a8 of _0x563d1c){const _0x5a8090=(_0x5b15a8?.['date']||'')['trim'](),_0x5b034=(_0x5b15a8?.['p_name']||'')['trim'](),_0x2be391=(_0x5b15a8?.['store_name']||'')['trim'](),_0x90cb40=(_0x5b15a8?.['machine_name']||'')['trim'](),_0x598351=(_0x5b15a8?.['machine_number']||'')['trim']();if(!_0x5a8090||!_0x5b034||!_0x2be391||!_0x90cb40||!_0x598351){_0x5e3b0a['push']({'reason':'Missing\x20required\x20fields','item':_0x5b15a8});continue;}const _0xaf0108=_0x2a3a38['get'](_0x5b034);if(!_0xaf0108){_0x5e3b0a['push']({'reason':'Prefecture\x20\x27'+_0x5b034+'\x27\x20not\x20found','item':_0x5b15a8});continue;}const _0x2d5eef=_0xe3ab6f['get'](_0x2be391+'_'+_0xaf0108);if(!_0x2d5eef){_0x5e3b0a['push']({'reason':'Store\x20\x27'+_0x2be391+'\x27\x20not\x20found\x20for\x20prefecture\x20'+_0x5b034,'item':_0x5b15a8});continue;}const _0x3a1d80=_0x4b2273['get'](_0x90cb40);if(!_0x3a1d80){_0x5e3b0a['push']({'reason':'Machine\x20\x27'+_0x90cb40+'\x27\x20not\x20found','item':_0x5b15a8});continue;}const _0x273906=_0x5a8090+'_'+_0x2d5eef+'_'+_0x3a1d80+'_'+_0x598351;if(_0x333e80['has'](_0x273906)){_0x5e3b0a['push']({'reason':'Record\x20already\x20exists','item':_0x5b15a8});continue;}if(_0x2042fd['has'](_0x273906)){_0x5e3b0a['push']({'reason':'Duplicate\x20in\x20input','item':_0x5b15a8});continue;}_0x17769e['push']({'_id':_0x44f082++,'date':_0x5a8090,'pref_id':_0xaf0108,'store_id':_0x2d5eef,'machine_id':_0x3a1d80,'machine_number':_0x598351,'credit_difference':(_0x5b15a8['credit_difference']||'')['trim'](),'game_count':(_0x5b15a8['game_count']||'')['trim'](),'payout_rate':(_0x5b15a8['payout_rate']||'')['trim'](),'bb':(_0x5b15a8['bb']||'')['trim'](),'rb':(_0x5b15a8['rb']||'')['trim'](),'synthesis':(_0x5b15a8['synthesis']||'')['trim'](),'bb_rate':(_0x5b15a8['bb_rate']||'')['trim'](),'rb_rate':(_0x5b15a8['rb_rate']||'')['trim'](),'data_url':(_0x5b15a8['data_url']||'')['trim']()}),_0x2042fd['add'](_0x273906),_0x2c53ce++;}const _0x57e0e9=0x3e8,_0x5e42fb=[];for(let _0x64a1f5=0x0;_0x64a1f5<_0x17769e['length'];_0x64a1f5+=_0x57e0e9){_0x5e42fb['push'](_0x17769e['slice'](_0x64a1f5,_0x64a1f5+_0x57e0e9));}let _0x200c8a=0x0,_0x56d003=0x0;const _0x1c8945=[];for(let _0x454bf0=0x0;_0x454bf0<_0x5e42fb['length'];_0x454bf0++){const _0x592e02=_0x5e42fb[_0x454bf0];try{const _0x2b8c7f=await models_1['default']['dailySlotData']['insertMany'](_0x592e02,{'ordered':![],'rawResult':![]});_0x200c8a+=_0x2b8c7f['length'];}catch(_0x1d38ad){_0x1d38ad?.['writeErrors']?(_0x56d003+=_0x1d38ad['writeErrors']['length'],_0x1d38ad['writeErrors']['forEach'](_0x27eb67=>{_0x1c8945['push']({'batch':_0x454bf0+0x1,'error':_0x27eb67?.['errmsg'],'document':_0x27eb67?.['op']});})):(_0x56d003+=_0x592e02['length'],_0x1c8945['push']({'batch':_0x454bf0+0x1,'error':_0x1d38ad?.['message'],'document':'entire\x20batch'}));}}return logger_1['logger']['info']('Bulk\x20operation\x20completed:\x20'+_0x200c8a+'\x20inserted,\x20'+_0x56d003+'\x20errors'),{'success':!![],'totalProcessed':_0x563d1c['length'],'validRecords':_0x2c53ce,'savedRows':_0x200c8a,'skippedRows':_0x5e3b0a['length'],'errors':_0x56d003,'errorDetails':_0x1c8945['slice'](0x0,0xa),'skipped':_0x5e3b0a['slice'](0x0,0x64)};}catch(_0x53f041){throw new customError_1['DatabaseError']('saveDatas\x20Error:\x20'+_0x53f041?.['message']);}}};exports['default']=dailySlotDataDB;
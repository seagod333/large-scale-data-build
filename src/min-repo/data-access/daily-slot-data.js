'use strict';var __importDefault=this&&this['__importDefault']||function(_0x21b693){return _0x21b693&&_0x21b693['__esModule']?_0x21b693:{'default':_0x21b693};};Object['defineProperty'](exports,'__esModule',{'value':!![]});const models_1=__importDefault(require('../models')),customError_1=require('../../@types/customError'),logger_1=require('../../utils/logger'),database_1=require('../../services/database'),dailySlotDataDB={'create':async _0x74b0f4=>{const _0xbdf114=new models_1['default']['dailySlotData'](_0x74b0f4),_0x411bf5=await _0xbdf114['save']();if(!_0x411bf5)throw new customError_1['DatabaseError']('dailySlotDataDB\x20Database\x20Error');return _0x411bf5;},'findOne':async({filter:_0x51e299})=>{return models_1['default']['dailySlotData']['findOne'](_0x51e299);},'find':async({filter:_0x2eaf12})=>{return models_1['default']['dailySlotData']['find'](_0x2eaf12);},'update':async({filter:_0x258d08,update:_0x4e1fa3})=>{return models_1['default']['dailySlotData']['findOneAndUpdate'](_0x258d08,_0x4e1fa3);},'remove':async({filter:_0x44608f})=>{const _0x3809a5=await models_1['default']['dailySlotData']['deleteOne'](_0x44608f);return{'found':_0x3809a5['n'],'deleted':_0x3809a5['deletedCount']};},'saveDatas':async _0x55f998=>{try{if(!_0x55f998||_0x55f998['length']===0x0)throw new customError_1['DatabaseError']('No\x20data\x20provided');logger_1['logger']['info']('Processing\x20'+_0x55f998['length']+'\x20daily\x20slot\x20records...');const _0x38b205=new Set();for(const _0x488217 of _0x55f998){if(_0x488217?.['date'])_0x38b205['add'](_0x488217['date']);}const _0x5e9927=Array['from'](_0x38b205),[_0x3fc5fb,_0x2e30a6,_0x40424c]=await Promise['all']([models_1['default']['prefectureModel']['find']({},{'_id':0x1,'p_name':0x1}),models_1['default']['storeMaster']['find']({},{'_id':0x1,'pref_id':0x1,'store_name':0x1}),models_1['default']['machineModel']['find']({},{'_id':0x1,'machine_name':0x1})]),_0xbbbdaf=new Map();_0x3fc5fb['forEach'](_0x9439c2=>{if(_0x9439c2?.['p_name'])_0xbbbdaf['set'](_0x9439c2['p_name'],_0x9439c2['_id']);});const _0x18f588=new Map();_0x2e30a6['forEach'](_0x47bbff=>{_0x47bbff?.['store_name']&&typeof _0x47bbff?.['pref_id']==='number'&&_0x18f588['set'](_0x47bbff['store_name']+'_'+_0x47bbff['pref_id'],_0x47bbff['_id']);});const _0x1120ab=new Map();_0x40424c['forEach'](_0x4117c8=>{if(_0x4117c8?.['machine_name'])_0x1120ab['set'](_0x4117c8['machine_name'],_0x4117c8['_id']);});const _0xc15466=await models_1['default']['dailySlotData']['find']({'date':{'$in':_0x5e9927}},{'_id':0x0,'date':0x1,'store_id':0x1,'machine_id':0x1,'machine_number':0x1}),_0x2dac40=new Set();_0xc15466['forEach'](_0x17a2e0=>{const _0x5cc6fd=_0x17a2e0['date']+'_'+_0x17a2e0['store_id']+'_'+_0x17a2e0['machine_id']+'_'+_0x17a2e0['machine_number'];_0x2dac40['add'](_0x5cc6fd);});let _0x236017=await(0x0,database_1['getLastIndex'])(models_1['default']['dailySlotData']);const _0x4daf79=[],_0x4178e3=[];let _0x3226a1=0x0;const _0x5b4a53=new Set();for(const _0x47f73d of _0x55f998){const _0x46a481=(_0x47f73d?.['date']||'')['trim'](),_0x38f479=(_0x47f73d?.['p_name']||'')['trim'](),_0x3286f8=(_0x47f73d?.['store_name']||'')['trim'](),_0x10de3a=(_0x47f73d?.['machine_name']||'')['trim'](),_0x4b63d1=(_0x47f73d?.['machine_number']||'')['trim']();if(!_0x46a481||!_0x38f479||!_0x3286f8||!_0x10de3a||!_0x4b63d1){_0x4178e3['push']({'reason':'Missing\x20required\x20fields','item':_0x47f73d});continue;}const _0x39c121=_0xbbbdaf['get'](_0x38f479);if(!_0x39c121){_0x4178e3['push']({'reason':'Prefecture\x20\x27'+_0x38f479+'\x27\x20not\x20found','item':_0x47f73d});continue;}const _0x3eaa51=_0x18f588['get'](_0x3286f8+'_'+_0x39c121);if(!_0x3eaa51){_0x4178e3['push']({'reason':'Store\x20\x27'+_0x3286f8+'\x27\x20not\x20found\x20for\x20prefecture\x20'+_0x38f479,'item':_0x47f73d});continue;}const _0x50b164=_0x1120ab['get'](_0x10de3a);if(!_0x50b164){_0x4178e3['push']({'reason':'Machine\x20\x27'+_0x10de3a+'\x27\x20not\x20found','item':_0x47f73d});continue;}const _0x27bed0=_0x46a481+'_'+_0x3eaa51+'_'+_0x50b164+'_'+_0x4b63d1;if(_0x2dac40['has'](_0x27bed0)){_0x4178e3['push']({'reason':'Record\x20already\x20exists','item':_0x47f73d});continue;}if(_0x5b4a53['has'](_0x27bed0)){_0x4178e3['push']({'reason':'Duplicate\x20in\x20input','item':_0x47f73d});continue;}_0x4daf79['push']({'_id':_0x236017++,'date':_0x46a481,'pref_id':_0x39c121,'store_id':_0x3eaa51,'machine_id':_0x50b164,'machine_number':_0x4b63d1,'credit_difference':(_0x47f73d['credit_difference']||'')['trim'](),'game_count':(_0x47f73d['game_count']||'')['trim'](),'payout_rate':(_0x47f73d['payout_rate']||'')['trim'](),'bb':(_0x47f73d['bb']||'')['trim'](),'rb':(_0x47f73d['rb']||'')['trim'](),'synthesis':(_0x47f73d['synthesis']||'')['trim'](),'bb_rate':(_0x47f73d['bb_rate']||'')['trim'](),'rb_rate':(_0x47f73d['rb_rate']||'')['trim'](),'data_url':(_0x47f73d['data_url']||'')['trim']()}),_0x5b4a53['add'](_0x27bed0),_0x3226a1++;}const _0xd6c978=0x3e8,_0x5639f4=[];for(let _0x19e887=0x0;_0x19e887<_0x4daf79['length'];_0x19e887+=_0xd6c978){_0x5639f4['push'](_0x4daf79['slice'](_0x19e887,_0x19e887+_0xd6c978));}let _0x28e00b=0x0,_0x43dec8=0x0;const _0x4ed42a=[];for(let _0x8f0ae4=0x0;_0x8f0ae4<_0x5639f4['length'];_0x8f0ae4++){const _0x3695c7=_0x5639f4[_0x8f0ae4];try{const _0x3c33e5=await models_1['default']['dailySlotData']['insertMany'](_0x3695c7,{'ordered':![],'rawResult':![]});_0x28e00b+=_0x3c33e5['length'];}catch(_0x2546fe){_0x2546fe?.['writeErrors']?(_0x43dec8+=_0x2546fe['writeErrors']['length'],_0x2546fe['writeErrors']['forEach'](_0xa4b370=>{_0x4ed42a['push']({'batch':_0x8f0ae4+0x1,'error':_0xa4b370?.['errmsg'],'document':_0xa4b370?.['op']});})):(_0x43dec8+=_0x3695c7['length'],_0x4ed42a['push']({'batch':_0x8f0ae4+0x1,'error':_0x2546fe?.['message'],'document':'entire\x20batch'}));}}return logger_1['logger']['info']('Bulk\x20operation\x20completed:\x20'+_0x28e00b+'\x20inserted,\x20'+_0x43dec8+'\x20errors'),{'success':!![],'totalProcessed':_0x55f998['length'],'validRecords':_0x3226a1,'savedRows':_0x28e00b,'skippedRows':_0x4178e3['length'],'errors':_0x43dec8,'errorDetails':_0x4ed42a['slice'](0x0,0xa),'skipped':_0x4178e3['slice'](0x0,0x64)};}catch(_0x21899f){throw new customError_1['DatabaseError']('saveDatas\x20Error:\x20'+_0x21899f?.['message']);}}};exports['default']=dailySlotDataDB;
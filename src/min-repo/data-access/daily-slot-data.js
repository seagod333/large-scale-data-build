'use strict';var __importDefault=this&&this['__importDefault']||function(_0x565f18){return _0x565f18&&_0x565f18['__esModule']?_0x565f18:{'default':_0x565f18};};Object['defineProperty'](exports,'__esModule',{'value':!![]});const models_1=__importDefault(require('../models')),customError_1=require('../../@types/customError'),logger_1=require('../../utils/logger'),database_1=require('../../services/database'),dailySlotDataDB={'create':async _0x58b413=>{const _0x5d7874=new models_1['default']['dailySlotData'](_0x58b413),_0x546806=await _0x5d7874['save']();if(!_0x546806)throw new customError_1['DatabaseError']('dailySlotDataDB\x20Database\x20Error');return _0x546806;},'findOne':async({filter:_0x3c113f})=>{return models_1['default']['dailySlotData']['findOne'](_0x3c113f);},'find':async({filter:_0x4c8584})=>{return models_1['default']['dailySlotData']['find'](_0x4c8584);},'update':async({filter:_0x53ab3a,update:_0x2c7cb4})=>{return models_1['default']['dailySlotData']['findOneAndUpdate'](_0x53ab3a,_0x2c7cb4);},'remove':async({filter:_0x313676})=>{const _0x25e453=await models_1['default']['dailySlotData']['deleteOne'](_0x313676);return{'found':_0x25e453['n'],'deleted':_0x25e453['deletedCount']};},'saveDatas':async _0x5aed57=>{try{if(!_0x5aed57||_0x5aed57['length']===0x0)throw new customError_1['DatabaseError']('No\x20data\x20provided');logger_1['logger']['info']('Processing\x20'+_0x5aed57['length']+'\x20daily\x20slot\x20records...');const _0x10401d=new Set();for(const _0x56ea0d of _0x5aed57){if(_0x56ea0d?.['date'])_0x10401d['add'](_0x56ea0d['date']);}const _0x3817be=Array['from'](_0x10401d),[_0x5a4828,_0x34148c,_0xb5514d]=await Promise['all']([models_1['default']['prefectureModel']['find']({},{'_id':0x1,'p_name':0x1}),models_1['default']['storeMaster']['find']({},{'_id':0x1,'pref_id':0x1,'store_name':0x1}),models_1['default']['machineModel']['find']({},{'_id':0x1,'machine_name':0x1})]),_0x1186a3=new Map();_0x5a4828['forEach'](_0x122a2a=>{if(_0x122a2a?.['p_name'])_0x1186a3['set'](_0x122a2a['p_name'],_0x122a2a['_id']);});const _0x1ef788=new Map();_0x34148c['forEach'](_0x1ea1fa=>{_0x1ea1fa?.['store_name']&&typeof _0x1ea1fa?.['pref_id']==='number'&&_0x1ef788['set'](_0x1ea1fa['store_name']+'_'+_0x1ea1fa['pref_id'],_0x1ea1fa['_id']);});const _0x1eceb8=new Map();_0xb5514d['forEach'](_0x5b9e9e=>{if(_0x5b9e9e?.['machine_name'])_0x1eceb8['set'](_0x5b9e9e['machine_name'],_0x5b9e9e['_id']);});const _0x1fe0ee=await models_1['default']['dailySlotData']['find']({'date':{'$in':_0x3817be}},{'_id':0x0,'date':0x1,'store_id':0x1,'machine_id':0x1,'machine_number':0x1}),_0x51354f=new Set();_0x1fe0ee['forEach'](_0x38ed64=>{const _0x75c702=_0x38ed64['date']+'_'+_0x38ed64['store_id']+'_'+_0x38ed64['machine_id']+'_'+_0x38ed64['machine_number'];_0x51354f['add'](_0x75c702);});let _0xf115f3=await(0x0,database_1['getLastIndex'])(models_1['default']['dailySlotData']);const _0x391ee0=[],_0x49e2d3=[];let _0x4d3c00=0x0;const _0x37f429=new Set();for(const _0xcff963 of _0x5aed57){const _0x5cca17=(_0xcff963?.['date']||'')['trim'](),_0x25f96e=(_0xcff963?.['p_name']||'')['trim'](),_0x59db74=(_0xcff963?.['store_name']||'')['trim'](),_0x1a0e8e=(_0xcff963?.['machine_name']||'')['trim'](),_0x36c79d=(_0xcff963?.['machine_number']||'')['trim']();if(!_0x5cca17||!_0x25f96e||!_0x59db74||!_0x1a0e8e||!_0x36c79d){_0x49e2d3['push']({'reason':'Missing\x20required\x20fields','item':_0xcff963});continue;}const _0x1a7805=_0x1186a3['get'](_0x25f96e);if(!_0x1a7805){_0x49e2d3['push']({'reason':'Prefecture\x20\x27'+_0x25f96e+'\x27\x20not\x20found','item':_0xcff963});continue;}const _0x2b77d7=_0x1ef788['get'](_0x59db74+'_'+_0x1a7805);if(!_0x2b77d7){_0x49e2d3['push']({'reason':'Store\x20\x27'+_0x59db74+'\x27\x20not\x20found\x20for\x20prefecture\x20'+_0x25f96e,'item':_0xcff963});continue;}const _0x5d7cf4=_0x1eceb8['get'](_0x1a0e8e);if(!_0x5d7cf4){_0x49e2d3['push']({'reason':'Machine\x20\x27'+_0x1a0e8e+'\x27\x20not\x20found','item':_0xcff963});continue;}const _0x335687=_0x5cca17+'_'+_0x2b77d7+'_'+_0x5d7cf4+'_'+_0x36c79d;if(_0x51354f['has'](_0x335687)){_0x49e2d3['push']({'reason':'Record\x20already\x20exists','item':_0xcff963});continue;}if(_0x37f429['has'](_0x335687)){_0x49e2d3['push']({'reason':'Duplicate\x20in\x20input','item':_0xcff963});continue;}_0x391ee0['push']({'_id':_0xf115f3++,'date':_0x5cca17,'pref_id':_0x1a7805,'store_id':_0x2b77d7,'machine_id':_0x5d7cf4,'machine_number':_0x36c79d,'credit_difference':(_0xcff963['credit_difference']||'')['trim'](),'game_count':(_0xcff963['game_count']||'')['trim'](),'payout_rate':(_0xcff963['payout_rate']||'')['trim'](),'bb':(_0xcff963['bb']||'')['trim'](),'rb':(_0xcff963['rb']||'')['trim'](),'synthesis':(_0xcff963['synthesis']||'')['trim'](),'bb_rate':(_0xcff963['bb_rate']||'')['trim'](),'rb_rate':(_0xcff963['rb_rate']||'')['trim'](),'data_url':(_0xcff963['data_url']||'')['trim']()}),_0x37f429['add'](_0x335687),_0x4d3c00++;}const _0xa9b128=0x3e8,_0x176fb1=[];for(let _0x84fa47=0x0;_0x84fa47<_0x391ee0['length'];_0x84fa47+=_0xa9b128){_0x176fb1['push'](_0x391ee0['slice'](_0x84fa47,_0x84fa47+_0xa9b128));}let _0x258712=0x0,_0x36120f=0x0;const _0x27308a=[];for(let _0x591e56=0x0;_0x591e56<_0x176fb1['length'];_0x591e56++){const _0x4eeb1a=_0x176fb1[_0x591e56];try{const _0x591ca3=await models_1['default']['dailySlotData']['insertMany'](_0x4eeb1a,{'ordered':![],'rawResult':![]});_0x258712+=_0x591ca3['length'];}catch(_0x2ab6de){_0x2ab6de?.['writeErrors']?(_0x36120f+=_0x2ab6de['writeErrors']['length'],_0x2ab6de['writeErrors']['forEach'](_0x1b532d=>{_0x27308a['push']({'batch':_0x591e56+0x1,'error':_0x1b532d?.['errmsg'],'document':_0x1b532d?.['op']});})):(_0x36120f+=_0x4eeb1a['length'],_0x27308a['push']({'batch':_0x591e56+0x1,'error':_0x2ab6de?.['message'],'document':'entire\x20batch'}));}}return logger_1['logger']['info']('Bulk\x20operation\x20completed:\x20'+_0x258712+'\x20inserted,\x20'+_0x36120f+'\x20errors'),{'success':!![],'totalProcessed':_0x5aed57['length'],'validRecords':_0x4d3c00,'savedRows':_0x258712,'skippedRows':_0x49e2d3['length'],'errors':_0x36120f,'errorDetails':_0x27308a['slice'](0x0,0xa),'skipped':_0x49e2d3['slice'](0x0,0x64)};}catch(_0x4ad002){throw new customError_1['DatabaseError']('saveDatas\x20Error:\x20'+_0x4ad002?.['message']);}}};exports['default']=dailySlotDataDB;
'use strict';var __importDefault=this&&this['__importDefault']||function(_0x40069a){return _0x40069a&&_0x40069a['__esModule']?_0x40069a:{'default':_0x40069a};};Object['defineProperty'](exports,'__esModule',{'value':!![]});const models_1=__importDefault(require('../models')),customError_1=require('../../@types/customError'),logger_1=require('../../utils/logger'),database_1=require('../../services/database'),dailySlotDataDB={'create':async _0xb85901=>{const _0x52c0f5=new models_1['default']['dailySlotData'](_0xb85901),_0x350de9=await _0x52c0f5['save']();if(!_0x350de9)throw new customError_1['DatabaseError']('dailySlotDataDB\x20Database\x20Error');return _0x350de9;},'findOne':async({filter:_0x4a3102})=>{return models_1['default']['dailySlotData']['findOne'](_0x4a3102);},'find':async({filter:_0x393227})=>{return models_1['default']['dailySlotData']['find'](_0x393227);},'update':async({filter:_0x141282,update:_0x29bd89})=>{return models_1['default']['dailySlotData']['findOneAndUpdate'](_0x141282,_0x29bd89);},'remove':async({filter:_0xedc9fd})=>{const _0x3239e7=await models_1['default']['dailySlotData']['deleteOne'](_0xedc9fd);return{'found':_0x3239e7['n'],'deleted':_0x3239e7['deletedCount']};},'saveDatas':async _0x4c6b93=>{try{if(!_0x4c6b93||_0x4c6b93['length']===0x0)throw new customError_1['DatabaseError']('No\x20data\x20provided');logger_1['logger']['info']('Processing\x20'+_0x4c6b93['length']+'\x20daily\x20slot\x20records...');const _0x45d6cc=new Set();for(const _0x2233bb of _0x4c6b93){if(_0x2233bb?.['date'])_0x45d6cc['add'](_0x2233bb['date']);}const _0x248381=Array['from'](_0x45d6cc),[_0x1e35c3,_0x187781,_0x104459]=await Promise['all']([models_1['default']['prefectureModel']['find']({},{'_id':0x1,'p_name':0x1}),models_1['default']['storeMaster']['find']({},{'_id':0x1,'pref_id':0x1,'store_name':0x1}),models_1['default']['machineModel']['find']({},{'_id':0x1,'machine_name':0x1})]),_0x178b4f=new Map();_0x1e35c3['forEach'](_0x48cad3=>{if(_0x48cad3?.['p_name'])_0x178b4f['set'](_0x48cad3['p_name'],_0x48cad3['_id']);});const _0x4b5944=new Map();_0x187781['forEach'](_0x303eb1=>{_0x303eb1?.['store_name']&&typeof _0x303eb1?.['pref_id']==='number'&&_0x4b5944['set'](_0x303eb1['store_name']+'_'+_0x303eb1['pref_id'],_0x303eb1['_id']);});const _0x2dddfa=new Map();_0x104459['forEach'](_0x49d159=>{if(_0x49d159?.['machine_name'])_0x2dddfa['set'](_0x49d159['machine_name'],_0x49d159['_id']);});const _0x17eb26=await models_1['default']['dailySlotData']['find']({'date':{'$in':_0x248381}},{'_id':0x0,'date':0x1,'store_id':0x1,'machine_id':0x1,'machine_number':0x1}),_0x523581=new Set();_0x17eb26['forEach'](_0x580ef6=>{const _0x343ba2=_0x580ef6['date']+'_'+_0x580ef6['store_id']+'_'+_0x580ef6['machine_id']+'_'+_0x580ef6['machine_number'];_0x523581['add'](_0x343ba2);});let _0x51c7a6=await(0x0,database_1['getLastIndex'])(models_1['default']['dailySlotData']);const _0xf2011e=[],_0x15269c=[];let _0x160e65=0x0;const _0x25c32e=new Set();for(const _0x29e167 of _0x4c6b93){const _0x17c646=(_0x29e167?.['date']||'')['trim'](),_0x8c6687=(_0x29e167?.['p_name']||'')['trim'](),_0x287951=(_0x29e167?.['store_name']||'')['trim'](),_0x1eb8a6=(_0x29e167?.['machine_name']||'')['trim'](),_0x563084=(_0x29e167?.['machine_number']||'')['trim']();if(!_0x17c646||!_0x8c6687||!_0x287951||!_0x1eb8a6||!_0x563084){_0x15269c['push']({'reason':'Missing\x20required\x20fields','item':_0x29e167});continue;}const _0x587fef=_0x178b4f['get'](_0x8c6687);if(!_0x587fef){_0x15269c['push']({'reason':'Prefecture\x20\x27'+_0x8c6687+'\x27\x20not\x20found','item':_0x29e167});continue;}const _0x892ebe=_0x4b5944['get'](_0x287951+'_'+_0x587fef);if(!_0x892ebe){_0x15269c['push']({'reason':'Store\x20\x27'+_0x287951+'\x27\x20not\x20found\x20for\x20prefecture\x20'+_0x8c6687,'item':_0x29e167});continue;}const _0x7cf068=_0x2dddfa['get'](_0x1eb8a6);if(!_0x7cf068){_0x15269c['push']({'reason':'Machine\x20\x27'+_0x1eb8a6+'\x27\x20not\x20found','item':_0x29e167});continue;}const _0x3677b4=_0x17c646+'_'+_0x892ebe+'_'+_0x7cf068+'_'+_0x563084;if(_0x523581['has'](_0x3677b4)){_0x15269c['push']({'reason':'Record\x20already\x20exists','item':_0x29e167});continue;}if(_0x25c32e['has'](_0x3677b4)){_0x15269c['push']({'reason':'Duplicate\x20in\x20input','item':_0x29e167});continue;}_0xf2011e['push']({'_id':_0x51c7a6++,'date':_0x17c646,'pref_id':_0x587fef,'store_id':_0x892ebe,'machine_id':_0x7cf068,'machine_number':_0x563084,'credit_difference':(_0x29e167['credit_difference']||'')['trim'](),'game_count':(_0x29e167['game_count']||'')['trim'](),'payout_rate':(_0x29e167['payout_rate']||'')['trim'](),'bb':(_0x29e167['bb']||'')['trim'](),'rb':(_0x29e167['rb']||'')['trim'](),'synthesis':(_0x29e167['synthesis']||'')['trim'](),'bb_rate':(_0x29e167['bb_rate']||'')['trim'](),'rb_rate':(_0x29e167['rb_rate']||'')['trim'](),'data_url':(_0x29e167['data_url']||'')['trim']()}),_0x25c32e['add'](_0x3677b4),_0x160e65++;}const _0x4d0e05=0x3e8,_0x50a8ab=[];for(let _0x1e3953=0x0;_0x1e3953<_0xf2011e['length'];_0x1e3953+=_0x4d0e05){_0x50a8ab['push'](_0xf2011e['slice'](_0x1e3953,_0x1e3953+_0x4d0e05));}let _0x35768b=0x0,_0x2a0d1f=0x0;const _0x3b3ff6=[];for(let _0x23a22f=0x0;_0x23a22f<_0x50a8ab['length'];_0x23a22f++){const _0xd29ec3=_0x50a8ab[_0x23a22f];try{const _0x30c0d1=await models_1['default']['dailySlotData']['insertMany'](_0xd29ec3,{'ordered':![],'rawResult':![]});_0x35768b+=_0x30c0d1['length'];}catch(_0x5c0c21){_0x5c0c21?.['writeErrors']?(_0x2a0d1f+=_0x5c0c21['writeErrors']['length'],_0x5c0c21['writeErrors']['forEach'](_0x3a3c4d=>{_0x3b3ff6['push']({'batch':_0x23a22f+0x1,'error':_0x3a3c4d?.['errmsg'],'document':_0x3a3c4d?.['op']});})):(_0x2a0d1f+=_0xd29ec3['length'],_0x3b3ff6['push']({'batch':_0x23a22f+0x1,'error':_0x5c0c21?.['message'],'document':'entire\x20batch'}));}}return logger_1['logger']['info']('Bulk\x20operation\x20completed:\x20'+_0x35768b+'\x20inserted,\x20'+_0x2a0d1f+'\x20errors'),{'success':!![],'totalProcessed':_0x4c6b93['length'],'validRecords':_0x160e65,'savedRows':_0x35768b,'skippedRows':_0x15269c['length'],'errors':_0x2a0d1f,'errorDetails':_0x3b3ff6['slice'](0x0,0xa),'skipped':_0x15269c['slice'](0x0,0x64)};}catch(_0x43883c){throw new customError_1['DatabaseError']('saveDatas\x20Error:\x20'+_0x43883c?.['message']);}}};exports['default']=dailySlotDataDB;
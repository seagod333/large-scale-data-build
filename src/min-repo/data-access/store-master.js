'use strict';var __importDefault=this&&this['__importDefault']||function(_0x320ef9){return _0x320ef9&&_0x320ef9['__esModule']?_0x320ef9:{'default':_0x320ef9};};Object['defineProperty'](exports,'__esModule',{'value':!![]});const fs_1=__importDefault(require('fs')),path_1=__importDefault(require('path')),models_1=__importDefault(require('../models')),customError_1=require('../../@types/customError'),logger_1=require('../../utils/logger'),prefecture_model_1=__importDefault(require('./prefecture-model')),database_1=require('../../services/database'),storeMasterDB={'create':async _0x22bce9=>{const _0xbd8f2a=new models_1['default']['storeMaster'](_0x22bce9),_0x2e8d23=await _0xbd8f2a['save']();if(!_0x2e8d23)throw new customError_1['DatabaseError']('storeMasterDB\x20Database\x20Error');return _0x2e8d23;},'findOne':async({filter:_0x4c457c})=>{return models_1['default']['storeMaster']['findOne'](_0x4c457c);},'find':async({filter:_0x1017b6})=>{return models_1['default']['storeMaster']['find'](_0x1017b6);},'update':async({filter:_0x21a0bc,update:_0x1be7a9})=>{return models_1['default']['storeMaster']['findOneAndUpdate'](_0x21a0bc,_0x1be7a9);},'remove':async({filter:_0x25d63b})=>{const _0x546352=await models_1['default']['storeMaster']['deleteOne'](_0x25d63b);return{'found':_0x546352['n'],'deleted':_0x546352['deletedCount']};},'saveDatas':async _0x53131f=>{try{if(!_0x53131f||_0x53131f['length']===0x0)throw new customError_1['DatabaseError']('No\x20data\x20provided');logger_1['logger']['info']('Processing\x20'+_0x53131f['length']+'\x20store\x20records...');const _0x31c1fb=new Map();try{const _0x4038c2=path_1['default']['join'](process['cwd'](),'src','config','prefecture-models-list.json'),_0x5160bd=fs_1['default']['readFileSync'](_0x4038c2,'utf8'),_0x5dba5f=JSON['parse'](_0x5160bd);_0x5dba5f['forEach'](_0x3f750e=>{_0x31c1fb['set'](_0x3f750e['p_name'],_0x3f750e['_id']);}),logger_1['logger']['info']('Loaded\x20'+_0x5dba5f['length']+'\x20prefectures\x20from\x20JSON\x20file');}catch(_0x2d7fbc){logger_1['logger']['warn']('Failed\x20to\x20load\x20prefecture\x20data\x20from\x20JSON,\x20falling\x20back\x20to\x20database\x20query');const _0x214ad5=await prefecture_model_1['default']['find']({'filter':{}});_0x214ad5['forEach'](_0x44e98b=>{_0x31c1fb['set'](_0x44e98b['p_name'],_0x44e98b['_id']);});}const _0x357889=new Set(),_0x2bc19a=await storeMasterDB['find']({'filter':{}});_0x2bc19a['forEach'](_0x13aee4=>{_0x357889['add'](_0x13aee4['store_name']+'_'+_0x13aee4['pref_id']);});let _0x17bed5=await(0x0,database_1['getLastIndex'])(models_1['default']['storeMaster']);const _0x3f08d7=[],_0x431cef=[];let _0x5c0be1=0x0;for(const _0x2c609d of _0x53131f){const _0x564fc7=_0x31c1fb['get'](_0x2c609d['p_name']);if(!_0x564fc7){_0x431cef['push']({'store_name':_0x2c609d['store_name'],'reason':'Prefecture\x20\x27'+_0x2c609d['p_name']+'\x27\x20not\x20found'});continue;}const _0x1bed47=_0x2c609d['store_name']+'_'+_0x564fc7;if(_0x357889['has'](_0x1bed47)){_0x431cef['push']({'store_name':_0x2c609d['store_name'],'reason':'Store\x20already\x20exists'});continue;}_0x3f08d7['push']({'_id':_0x17bed5++,'pref_id':_0x564fc7,'store_name':_0x2c609d['store_name'],'store_url':_0x2c609d['store_url']}),_0x5c0be1++;}const _0x4560d1=0x3e8,_0x36316e=[];for(let _0x2d4b12=0x0;_0x2d4b12<_0x3f08d7['length'];_0x2d4b12+=_0x4560d1){_0x36316e['push'](_0x3f08d7['slice'](_0x2d4b12,_0x2d4b12+_0x4560d1));}let _0x42e753=0x0,_0x48c35e=0x0;const _0x1d0e2a=[];for(let _0x4cc0bc=0x0;_0x4cc0bc<_0x36316e['length'];_0x4cc0bc++){const _0x15448f=_0x36316e[_0x4cc0bc];try{const _0x4be50d=await models_1['default']['storeMaster']['insertMany'](_0x15448f,{'ordered':![],'rawResult':![]});_0x42e753+=_0x4be50d['length'];}catch(_0xc7795d){_0xc7795d['writeErrors']?(_0x48c35e+=_0xc7795d['writeErrors']['length'],_0xc7795d['writeErrors']['forEach'](_0x5c66c0=>{_0x1d0e2a['push']({'batch':_0x4cc0bc+0x1,'error':_0x5c66c0['errmsg'],'document':_0x5c66c0['op']});})):(_0x48c35e+=_0x15448f['length'],_0x1d0e2a['push']({'batch':_0x4cc0bc+0x1,'error':_0xc7795d['message'],'document':'entire\x20batch'}));}}return logger_1['logger']['info']('Bulk\x20operation\x20completed:\x20'+_0x42e753+'\x20inserted,\x20'+_0x48c35e+'\x20errors'),{'success':!![],'totalProcessed':_0x53131f['length'],'validRecords':_0x5c0be1,'savedStores':_0x42e753,'skippedStores':_0x431cef['length'],'errors':_0x48c35e,'errorDetails':_0x1d0e2a['slice'](0x0,0xa),'skipped':_0x431cef['slice'](0x0,0x64)};}catch(_0x2b64a2){logger_1['logger']['error']('saveDatas\x20Error:\x20'+_0x2b64a2['message']);throw new customError_1['DatabaseError']('saveDatas\x20Error:\x20'+_0x2b64a2['message']);}},'getStoreDatas':async _0x53f774=>{if(!_0x53f774||_0x53f774<=0x0)return[];const _0x2f2d70=await models_1['default']['storeMaster']['aggregate']([{'$match':{}},{'$limit':_0x53f774},{'$lookup':{'from':'prefecture-models','localField':'pref_id','foreignField':'_id','as':'pref'}},{'$unwind':{'path':'$pref','preserveNullAndEmptyArrays':!![]}},{'$project':{'_id':0x0,'p_name':{'$ifNull':['$pref.p_name','']},'store_name':0x1,'store_url':0x1}}]);return _0x2f2d70;}};exports['default']=storeMasterDB;
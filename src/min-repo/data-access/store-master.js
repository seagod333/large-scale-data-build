'use strict';var __importDefault=this&&this['__importDefault']||function(_0x43f1bc){return _0x43f1bc&&_0x43f1bc['__esModule']?_0x43f1bc:{'default':_0x43f1bc};};Object['defineProperty'](exports,'__esModule',{'value':!![]});const fs_1=__importDefault(require('fs')),path_1=__importDefault(require('path')),models_1=__importDefault(require('../models')),customError_1=require('../../@types/customError'),logger_1=require('../../utils/logger'),prefecture_model_1=__importDefault(require('./prefecture-model')),database_1=require('../../services/database'),storeMasterDB={'create':async _0x3c0910=>{const _0x6d6ee7=new models_1['default']['storeMaster'](_0x3c0910),_0xdc4220=await _0x6d6ee7['save']();if(!_0xdc4220)throw new customError_1['DatabaseError']('storeMasterDB\x20Database\x20Error');return _0xdc4220;},'findOne':async({filter:_0x2b87df})=>{return models_1['default']['storeMaster']['findOne'](_0x2b87df);},'find':async({filter:_0x4baec3})=>{return models_1['default']['storeMaster']['find'](_0x4baec3);},'update':async({filter:_0x101573,update:_0x1972a8})=>{return models_1['default']['storeMaster']['findOneAndUpdate'](_0x101573,_0x1972a8);},'remove':async({filter:_0x189c12})=>{const _0x573675=await models_1['default']['storeMaster']['deleteOne'](_0x189c12);return{'found':_0x573675['n'],'deleted':_0x573675['deletedCount']};},'saveDatas':async _0x468bb7=>{try{if(!_0x468bb7||_0x468bb7['length']===0x0)throw new customError_1['DatabaseError']('No\x20data\x20provided');logger_1['logger']['info']('Processing\x20'+_0x468bb7['length']+'\x20store\x20records...');const _0xccf8ca=new Map();try{const _0x1bcbe4=path_1['default']['join'](process['cwd'](),'src','config','prefecture-models-list.json'),_0x48cb51=fs_1['default']['readFileSync'](_0x1bcbe4,'utf8'),_0x3b595a=JSON['parse'](_0x48cb51);_0x3b595a['forEach'](_0x19cfc0=>{_0xccf8ca['set'](_0x19cfc0['p_name'],_0x19cfc0['_id']);}),logger_1['logger']['info']('Loaded\x20'+_0x3b595a['length']+'\x20prefectures\x20from\x20JSON\x20file');}catch(_0x3a285f){logger_1['logger']['warn']('Failed\x20to\x20load\x20prefecture\x20data\x20from\x20JSON,\x20falling\x20back\x20to\x20database\x20query');const _0x1a1790=await prefecture_model_1['default']['find']({'filter':{}});_0x1a1790['forEach'](_0x36c971=>{_0xccf8ca['set'](_0x36c971['p_name'],_0x36c971['_id']);});}const _0x5c52f7=new Set(),_0xed7166=await storeMasterDB['find']({'filter':{}});_0xed7166['forEach'](_0xed46ca=>{_0x5c52f7['add'](_0xed46ca['store_name']+'_'+_0xed46ca['pref_id']);});let _0x1d46f7=await(0x0,database_1['getLastIndex'])(models_1['default']['storeMaster']);const _0x3ae9c9=[],_0x2d51d4=[];let _0x45a6ee=0x0;for(const _0x300051 of _0x468bb7){const _0x3caa57=_0xccf8ca['get'](_0x300051['p_name']);if(!_0x3caa57){_0x2d51d4['push']({'store_name':_0x300051['store_name'],'reason':'Prefecture\x20\x27'+_0x300051['p_name']+'\x27\x20not\x20found'});continue;}const _0x2a7811=_0x300051['store_name']+'_'+_0x3caa57;if(_0x5c52f7['has'](_0x2a7811)){_0x2d51d4['push']({'store_name':_0x300051['store_name'],'reason':'Store\x20already\x20exists'});continue;}_0x3ae9c9['push']({'_id':_0x1d46f7++,'pref_id':_0x3caa57,'store_name':_0x300051['store_name'],'store_url':_0x300051['store_url']}),_0x45a6ee++;}const _0x309278=0x3e8,_0x25771f=[];for(let _0x2eb5f8=0x0;_0x2eb5f8<_0x3ae9c9['length'];_0x2eb5f8+=_0x309278){_0x25771f['push'](_0x3ae9c9['slice'](_0x2eb5f8,_0x2eb5f8+_0x309278));}let _0x42673d=0x0,_0x5f00c4=0x0;const _0xb2a553=[];for(let _0x20cdce=0x0;_0x20cdce<_0x25771f['length'];_0x20cdce++){const _0xe43931=_0x25771f[_0x20cdce];try{const _0x3d5e11=await models_1['default']['storeMaster']['insertMany'](_0xe43931,{'ordered':![],'rawResult':![]});_0x42673d+=_0x3d5e11['length'];}catch(_0xc4e36b){_0xc4e36b['writeErrors']?(_0x5f00c4+=_0xc4e36b['writeErrors']['length'],_0xc4e36b['writeErrors']['forEach'](_0x3b33bb=>{_0xb2a553['push']({'batch':_0x20cdce+0x1,'error':_0x3b33bb['errmsg'],'document':_0x3b33bb['op']});})):(_0x5f00c4+=_0xe43931['length'],_0xb2a553['push']({'batch':_0x20cdce+0x1,'error':_0xc4e36b['message'],'document':'entire\x20batch'}));}}return logger_1['logger']['info']('Bulk\x20operation\x20completed:\x20'+_0x42673d+'\x20inserted,\x20'+_0x5f00c4+'\x20errors'),{'success':!![],'totalProcessed':_0x468bb7['length'],'validRecords':_0x45a6ee,'savedStores':_0x42673d,'skippedStores':_0x2d51d4['length'],'errors':_0x5f00c4,'errorDetails':_0xb2a553['slice'](0x0,0xa),'skipped':_0x2d51d4['slice'](0x0,0x64)};}catch(_0x3511e3){logger_1['logger']['error']('saveDatas\x20Error:\x20'+_0x3511e3['message']);throw new customError_1['DatabaseError']('saveDatas\x20Error:\x20'+_0x3511e3['message']);}},'getStoreDatas':async _0x42b4ec=>{if(!_0x42b4ec||_0x42b4ec<=0x0)return[];const _0x4735c2=await models_1['default']['storeMaster']['aggregate']([{'$match':{}},{'$limit':_0x42b4ec},{'$lookup':{'from':'prefecture-models','localField':'pref_id','foreignField':'_id','as':'pref'}},{'$unwind':{'path':'$pref','preserveNullAndEmptyArrays':!![]}},{'$project':{'_id':0x0,'p_name':{'$ifNull':['$pref.p_name','']},'store_name':0x1,'store_url':0x1}}]);return _0x4735c2;}};exports['default']=storeMasterDB;
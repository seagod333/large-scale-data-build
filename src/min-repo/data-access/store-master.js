'use strict';var __importDefault=this&&this['__importDefault']||function(_0x402066){return _0x402066&&_0x402066['__esModule']?_0x402066:{'default':_0x402066};};Object['defineProperty'](exports,'__esModule',{'value':!![]});const fs_1=__importDefault(require('fs')),path_1=__importDefault(require('path')),models_1=__importDefault(require('../models')),customError_1=require('../../@types/customError'),logger_1=require('../../utils/logger'),prefecture_model_1=__importDefault(require('./prefecture-model')),database_1=require('../../services/database'),storeMasterDB={'create':async _0x4092e9=>{const _0x3b6d78=new models_1['default']['storeMaster'](_0x4092e9),_0x21fddf=await _0x3b6d78['save']();if(!_0x21fddf)throw new customError_1['DatabaseError']('storeMasterDB\x20Database\x20Error');return _0x21fddf;},'findOne':async({filter:_0x2ce00d})=>{return models_1['default']['storeMaster']['findOne'](_0x2ce00d);},'find':async({filter:_0x7133fa})=>{return models_1['default']['storeMaster']['find'](_0x7133fa);},'update':async({filter:_0xd08d95,update:_0x2631da})=>{return models_1['default']['storeMaster']['findOneAndUpdate'](_0xd08d95,_0x2631da);},'remove':async({filter:_0x47cd95})=>{const _0x3b081a=await models_1['default']['storeMaster']['deleteOne'](_0x47cd95);return{'found':_0x3b081a['n'],'deleted':_0x3b081a['deletedCount']};},'saveDatas':async _0x3b1605=>{try{if(!_0x3b1605||_0x3b1605['length']===0x0)throw new customError_1['DatabaseError']('No\x20data\x20provided');logger_1['logger']['info']('Processing\x20'+_0x3b1605['length']+'\x20store\x20records...');const _0x5dee67=new Map();try{const _0x387f9e=path_1['default']['join'](process['cwd'](),'src','config','prefecture-models-list.json'),_0x5029af=fs_1['default']['readFileSync'](_0x387f9e,'utf8'),_0x16b83c=JSON['parse'](_0x5029af);_0x16b83c['forEach'](_0x2c580c=>{_0x5dee67['set'](_0x2c580c['p_name'],_0x2c580c['_id']);}),logger_1['logger']['info']('Loaded\x20'+_0x16b83c['length']+'\x20prefectures\x20from\x20JSON\x20file');}catch(_0x70b03f){logger_1['logger']['warn']('Failed\x20to\x20load\x20prefecture\x20data\x20from\x20JSON,\x20falling\x20back\x20to\x20database\x20query');const _0xb31d9a=await prefecture_model_1['default']['find']({'filter':{}});_0xb31d9a['forEach'](_0x220b59=>{_0x5dee67['set'](_0x220b59['p_name'],_0x220b59['_id']);});}const _0x305c28=new Set(),_0x4718f1=await storeMasterDB['find']({'filter':{}});_0x4718f1['forEach'](_0x5b62b5=>{_0x305c28['add'](_0x5b62b5['store_name']+'_'+_0x5b62b5['pref_id']);});let _0x2831b0=await(0x0,database_1['getLastIndex'])(models_1['default']['storeMaster']);const _0x386ac6=[],_0x5c7926=[];let _0x542912=0x0;for(const _0x142114 of _0x3b1605){const _0x412606=_0x5dee67['get'](_0x142114['p_name']);if(!_0x412606){_0x5c7926['push']({'store_name':_0x142114['store_name'],'reason':'Prefecture\x20\x27'+_0x142114['p_name']+'\x27\x20not\x20found'});continue;}const _0x1651cb=_0x142114['store_name']+'_'+_0x412606;if(_0x305c28['has'](_0x1651cb)){_0x5c7926['push']({'store_name':_0x142114['store_name'],'reason':'Store\x20already\x20exists'});continue;}_0x386ac6['push']({'_id':_0x2831b0++,'pref_id':_0x412606,'store_name':_0x142114['store_name'],'store_url':_0x142114['store_url']}),_0x542912++;}const _0x5c4a61=0x3e8,_0x1db3fc=[];for(let _0x29cf52=0x0;_0x29cf52<_0x386ac6['length'];_0x29cf52+=_0x5c4a61){_0x1db3fc['push'](_0x386ac6['slice'](_0x29cf52,_0x29cf52+_0x5c4a61));}let _0x11820f=0x0,_0x293411=0x0;const _0x32cf8a=[];for(let _0x2d30e3=0x0;_0x2d30e3<_0x1db3fc['length'];_0x2d30e3++){const _0x59941a=_0x1db3fc[_0x2d30e3];try{const _0x2bb1ec=await models_1['default']['storeMaster']['insertMany'](_0x59941a,{'ordered':![],'rawResult':![]});_0x11820f+=_0x2bb1ec['length'];}catch(_0x46b7a5){_0x46b7a5['writeErrors']?(_0x293411+=_0x46b7a5['writeErrors']['length'],_0x46b7a5['writeErrors']['forEach'](_0x5454ac=>{_0x32cf8a['push']({'batch':_0x2d30e3+0x1,'error':_0x5454ac['errmsg'],'document':_0x5454ac['op']});})):(_0x293411+=_0x59941a['length'],_0x32cf8a['push']({'batch':_0x2d30e3+0x1,'error':_0x46b7a5['message'],'document':'entire\x20batch'}));}}return logger_1['logger']['info']('Bulk\x20operation\x20completed:\x20'+_0x11820f+'\x20inserted,\x20'+_0x293411+'\x20errors'),{'success':!![],'totalProcessed':_0x3b1605['length'],'validRecords':_0x542912,'savedStores':_0x11820f,'skippedStores':_0x5c7926['length'],'errors':_0x293411,'errorDetails':_0x32cf8a['slice'](0x0,0xa),'skipped':_0x5c7926['slice'](0x0,0x64)};}catch(_0x51a89a){logger_1['logger']['error']('saveDatas\x20Error:\x20'+_0x51a89a['message']);throw new customError_1['DatabaseError']('saveDatas\x20Error:\x20'+_0x51a89a['message']);}},'getStoreDatas':async _0xf3bf7d=>{if(!_0xf3bf7d||_0xf3bf7d<=0x0)return[];const _0x1b8223=await models_1['default']['storeMaster']['aggregate']([{'$match':{}},{'$limit':_0xf3bf7d},{'$lookup':{'from':'prefecture-models','localField':'pref_id','foreignField':'_id','as':'pref'}},{'$unwind':{'path':'$pref','preserveNullAndEmptyArrays':!![]}},{'$project':{'_id':0x0,'p_name':{'$ifNull':['$pref.p_name','']},'store_name':0x1,'store_url':0x1}}]);return _0x1b8223;}};exports['default']=storeMasterDB;
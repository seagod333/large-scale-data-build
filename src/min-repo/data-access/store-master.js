'use strict';var __importDefault=this&&this['__importDefault']||function(_0x641353){return _0x641353&&_0x641353['__esModule']?_0x641353:{'default':_0x641353};};Object['defineProperty'](exports,'__esModule',{'value':!![]});const fs_1=__importDefault(require('fs')),path_1=__importDefault(require('path')),models_1=__importDefault(require('../models')),customError_1=require('../../@types/customError'),logger_1=require('../../utils/logger'),prefecture_model_1=__importDefault(require('./prefecture-model')),database_1=require('../../services/database'),storeMasterDB={'create':async _0x1e54d8=>{const _0x228298=new models_1['default']['storeMaster'](_0x1e54d8),_0x3dc8d3=await _0x228298['save']();if(!_0x3dc8d3)throw new customError_1['DatabaseError']('storeMasterDB\x20Database\x20Error');return _0x3dc8d3;},'findOne':async({filter:_0x3beaa2})=>{return models_1['default']['storeMaster']['findOne'](_0x3beaa2);},'find':async({filter:_0x24ee2e})=>{return models_1['default']['storeMaster']['find'](_0x24ee2e);},'update':async({filter:_0x7f09a1,update:_0x12e611})=>{return models_1['default']['storeMaster']['findOneAndUpdate'](_0x7f09a1,_0x12e611);},'remove':async({filter:_0x2be99f})=>{const _0x3d6abf=await models_1['default']['storeMaster']['deleteOne'](_0x2be99f);return{'found':_0x3d6abf['n'],'deleted':_0x3d6abf['deletedCount']};},'saveDatas':async _0x472e5c=>{try{if(!_0x472e5c||_0x472e5c['length']===0x0)throw new customError_1['DatabaseError']('No\x20data\x20provided');logger_1['logger']['info']('Processing\x20'+_0x472e5c['length']+'\x20store\x20records...');const _0x575ad2=new Map();try{const _0x1e6ab1=path_1['default']['join'](process['cwd'](),'src','config','prefecture-models-list.json'),_0x46f789=fs_1['default']['readFileSync'](_0x1e6ab1,'utf8'),_0x42c251=JSON['parse'](_0x46f789);_0x42c251['forEach'](_0x1d25a5=>{_0x575ad2['set'](_0x1d25a5['p_name'],_0x1d25a5['_id']);}),logger_1['logger']['info']('Loaded\x20'+_0x42c251['length']+'\x20prefectures\x20from\x20JSON\x20file');}catch(_0x5283aa){logger_1['logger']['warn']('Failed\x20to\x20load\x20prefecture\x20data\x20from\x20JSON,\x20falling\x20back\x20to\x20database\x20query');const _0x1e0493=await prefecture_model_1['default']['find']({'filter':{}});_0x1e0493['forEach'](_0x173714=>{_0x575ad2['set'](_0x173714['p_name'],_0x173714['_id']);});}const _0x1f2f41=new Set(),_0x32506d=await storeMasterDB['find']({'filter':{}});_0x32506d['forEach'](_0x4d8dd4=>{_0x1f2f41['add'](_0x4d8dd4['store_name']+'_'+_0x4d8dd4['pref_id']);});let _0x4eb00d=await(0x0,database_1['getLastIndex'])(models_1['default']['storeMaster']);const _0x2356c5=[],_0x1ae756=[];let _0x1e7b91=0x0;for(const _0x7bb2fe of _0x472e5c){const _0x38b124=_0x575ad2['get'](_0x7bb2fe['p_name']);if(!_0x38b124){_0x1ae756['push']({'store_name':_0x7bb2fe['store_name'],'reason':'Prefecture\x20\x27'+_0x7bb2fe['p_name']+'\x27\x20not\x20found'});continue;}const _0x237982=_0x7bb2fe['store_name']+'_'+_0x38b124;if(_0x1f2f41['has'](_0x237982)){_0x1ae756['push']({'store_name':_0x7bb2fe['store_name'],'reason':'Store\x20already\x20exists'});continue;}_0x2356c5['push']({'_id':_0x4eb00d++,'pref_id':_0x38b124,'store_name':_0x7bb2fe['store_name'],'store_url':_0x7bb2fe['store_url']}),_0x1e7b91++;}const _0x55f412=0x3e8,_0xbd7657=[];for(let _0x9d8e5b=0x0;_0x9d8e5b<_0x2356c5['length'];_0x9d8e5b+=_0x55f412){_0xbd7657['push'](_0x2356c5['slice'](_0x9d8e5b,_0x9d8e5b+_0x55f412));}let _0x2e6677=0x0,_0x32994a=0x0;const _0xbf88bf=[];for(let _0x4972fd=0x0;_0x4972fd<_0xbd7657['length'];_0x4972fd++){const _0x3f626b=_0xbd7657[_0x4972fd];try{const _0x10677a=await models_1['default']['storeMaster']['insertMany'](_0x3f626b,{'ordered':![],'rawResult':![]});_0x2e6677+=_0x10677a['length'];}catch(_0x4e9ce4){_0x4e9ce4['writeErrors']?(_0x32994a+=_0x4e9ce4['writeErrors']['length'],_0x4e9ce4['writeErrors']['forEach'](_0x1cf619=>{_0xbf88bf['push']({'batch':_0x4972fd+0x1,'error':_0x1cf619['errmsg'],'document':_0x1cf619['op']});})):(_0x32994a+=_0x3f626b['length'],_0xbf88bf['push']({'batch':_0x4972fd+0x1,'error':_0x4e9ce4['message'],'document':'entire\x20batch'}));}}return logger_1['logger']['info']('Bulk\x20operation\x20completed:\x20'+_0x2e6677+'\x20inserted,\x20'+_0x32994a+'\x20errors'),{'success':!![],'totalProcessed':_0x472e5c['length'],'validRecords':_0x1e7b91,'savedStores':_0x2e6677,'skippedStores':_0x1ae756['length'],'errors':_0x32994a,'errorDetails':_0xbf88bf['slice'](0x0,0xa),'skipped':_0x1ae756['slice'](0x0,0x64)};}catch(_0x1fc58f){logger_1['logger']['error']('saveDatas\x20Error:\x20'+_0x1fc58f['message']);throw new customError_1['DatabaseError']('saveDatas\x20Error:\x20'+_0x1fc58f['message']);}},'getStoreDatas':async _0x906bb8=>{if(!_0x906bb8||_0x906bb8<=0x0)return[];const _0x523245=await models_1['default']['storeMaster']['aggregate']([{'$match':{}},{'$limit':_0x906bb8},{'$lookup':{'from':'prefecture-models','localField':'pref_id','foreignField':'_id','as':'pref'}},{'$unwind':{'path':'$pref','preserveNullAndEmptyArrays':!![]}},{'$project':{'_id':0x0,'p_name':{'$ifNull':['$pref.p_name','']},'store_name':0x1,'store_url':0x1}}]);return _0x523245;}};exports['default']=storeMasterDB;
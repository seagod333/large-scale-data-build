'use strict';var __importDefault=this&&this['__importDefault']||function(_0x109a09){return _0x109a09&&_0x109a09['__esModule']?_0x109a09:{'default':_0x109a09};};Object['defineProperty'](exports,'__esModule',{'value':!![]});const fs_1=__importDefault(require('fs')),path_1=__importDefault(require('path')),models_1=__importDefault(require('../models')),customError_1=require('../../@types/customError'),logger_1=require('../../utils/logger'),prefecture_model_1=__importDefault(require('./prefecture-model')),database_1=require('../../services/database'),storeMasterDB={'create':async _0x56bba6=>{const _0x3fdb85=new models_1['default']['storeMaster'](_0x56bba6),_0x894951=await _0x3fdb85['save']();if(!_0x894951)throw new customError_1['DatabaseError']('storeMasterDB\x20Database\x20Error');return _0x894951;},'findOne':async({filter:_0x59750a})=>{return models_1['default']['storeMaster']['findOne'](_0x59750a);},'find':async({filter:_0x26ac37})=>{return models_1['default']['storeMaster']['find'](_0x26ac37);},'update':async({filter:_0x239b01,update:_0x359530})=>{return models_1['default']['storeMaster']['findOneAndUpdate'](_0x239b01,_0x359530);},'remove':async({filter:_0x26f226})=>{const _0x188b1e=await models_1['default']['storeMaster']['deleteOne'](_0x26f226);return{'found':_0x188b1e['n'],'deleted':_0x188b1e['deletedCount']};},'saveDatas':async _0x2a97e5=>{try{if(!_0x2a97e5||_0x2a97e5['length']===0x0)throw new customError_1['DatabaseError']('No\x20data\x20provided');logger_1['logger']['info']('Processing\x20'+_0x2a97e5['length']+'\x20store\x20records...');const _0x2394e9=new Map();try{const _0x30db64=path_1['default']['join'](process['cwd'](),'src','config','prefecture-models-list.json'),_0x1a2410=fs_1['default']['readFileSync'](_0x30db64,'utf8'),_0x382872=JSON['parse'](_0x1a2410);_0x382872['forEach'](_0x15fc9f=>{_0x2394e9['set'](_0x15fc9f['p_name'],_0x15fc9f['_id']);}),logger_1['logger']['info']('Loaded\x20'+_0x382872['length']+'\x20prefectures\x20from\x20JSON\x20file');}catch(_0xbe1d46){logger_1['logger']['warn']('Failed\x20to\x20load\x20prefecture\x20data\x20from\x20JSON,\x20falling\x20back\x20to\x20database\x20query');const _0x2b87ab=await prefecture_model_1['default']['find']({'filter':{}});_0x2b87ab['forEach'](_0x166480=>{_0x2394e9['set'](_0x166480['p_name'],_0x166480['_id']);});}const _0x4a2217=new Set(),_0x4b76bb=await storeMasterDB['find']({'filter':{}});_0x4b76bb['forEach'](_0x5b6121=>{_0x4a2217['add'](_0x5b6121['store_name']+'_'+_0x5b6121['pref_id']);});let _0x1974bb=await(0x0,database_1['getLastIndex'])(models_1['default']['storeMaster']);const _0x528638=[],_0x21256b=[];let _0x26b8b1=0x0;for(const _0x3219c2 of _0x2a97e5){const _0x18a803=_0x2394e9['get'](_0x3219c2['p_name']);if(!_0x18a803){_0x21256b['push']({'store_name':_0x3219c2['store_name'],'reason':'Prefecture\x20\x27'+_0x3219c2['p_name']+'\x27\x20not\x20found'});continue;}const _0x53fbea=_0x3219c2['store_name']+'_'+_0x18a803;if(_0x4a2217['has'](_0x53fbea)){_0x21256b['push']({'store_name':_0x3219c2['store_name'],'reason':'Store\x20already\x20exists'});continue;}_0x528638['push']({'_id':_0x1974bb++,'pref_id':_0x18a803,'store_name':_0x3219c2['store_name'],'store_url':_0x3219c2['store_url']}),_0x26b8b1++;}const _0x14363c=0x3e8,_0x4e11c2=[];for(let _0x2b5d4f=0x0;_0x2b5d4f<_0x528638['length'];_0x2b5d4f+=_0x14363c){_0x4e11c2['push'](_0x528638['slice'](_0x2b5d4f,_0x2b5d4f+_0x14363c));}let _0x2c8250=0x0,_0x339d42=0x0;const _0x5eff5e=[];for(let _0x2f5279=0x0;_0x2f5279<_0x4e11c2['length'];_0x2f5279++){const _0x168a5c=_0x4e11c2[_0x2f5279];try{const _0x31ba49=await models_1['default']['storeMaster']['insertMany'](_0x168a5c,{'ordered':![],'rawResult':![]});_0x2c8250+=_0x31ba49['length'];}catch(_0x15e07b){_0x15e07b['writeErrors']?(_0x339d42+=_0x15e07b['writeErrors']['length'],_0x15e07b['writeErrors']['forEach'](_0x5efe93=>{_0x5eff5e['push']({'batch':_0x2f5279+0x1,'error':_0x5efe93['errmsg'],'document':_0x5efe93['op']});})):(_0x339d42+=_0x168a5c['length'],_0x5eff5e['push']({'batch':_0x2f5279+0x1,'error':_0x15e07b['message'],'document':'entire\x20batch'}));}}return logger_1['logger']['info']('Bulk\x20operation\x20completed:\x20'+_0x2c8250+'\x20inserted,\x20'+_0x339d42+'\x20errors'),{'success':!![],'totalProcessed':_0x2a97e5['length'],'validRecords':_0x26b8b1,'savedStores':_0x2c8250,'skippedStores':_0x21256b['length'],'errors':_0x339d42,'errorDetails':_0x5eff5e['slice'](0x0,0xa),'skipped':_0x21256b['slice'](0x0,0x64)};}catch(_0x107b4d){logger_1['logger']['error']('saveDatas\x20Error:\x20'+_0x107b4d['message']);throw new customError_1['DatabaseError']('saveDatas\x20Error:\x20'+_0x107b4d['message']);}},'getStoreDatas':async _0x1e3454=>{if(!_0x1e3454||_0x1e3454<=0x0)return[];const _0x50f45=await models_1['default']['storeMaster']['aggregate']([{'$match':{}},{'$limit':_0x1e3454},{'$lookup':{'from':'prefecture-models','localField':'pref_id','foreignField':'_id','as':'pref'}},{'$unwind':{'path':'$pref','preserveNullAndEmptyArrays':!![]}},{'$project':{'_id':0x0,'p_name':{'$ifNull':['$pref.p_name','']},'store_name':0x1,'store_url':0x1}}]);return _0x50f45;}};exports['default']=storeMasterDB;